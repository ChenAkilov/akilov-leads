<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AKILOV ‚Äì Leads Library ¬∑ Search ¬∑ CRM ¬∑ Working ¬∑ Maps</title>
<!-- v2025-08-13: Sync now enriches (phone/website + email/social) and saves to Library -->
<style>
:root{ --bg:#0c0f14; --card:#131822; --text:#e8eaee; --muted:#9da6b5; --border:#263043; --accent:#0ea5a6; --table-stripe:transparent; }
html[data-theme="light"]{ --bg:#ffffff; --card:#f6f7fb; --text:#0c0f14; --muted:#5c6575; --border:#e3e8f3; --table-stripe:#f0f3fa; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;transition:background-color .2s,color .2s}
.container{max-width:1240px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;transition:background-color .2s,border-color .2s}
h2{margin:0 0 8px 0} .small{font-size:12px;color:var(--muted)}
.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
.select{appearance:none}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;cursor:pointer;font-size:13px;transition:transform .05s,opacity .2s,background-color .2s,color .2s;text-decoration:none;display:inline-block}
html[data-theme="light"] .btn{background:#1f2937;color:#e5e7eb} .btn.primary{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.grid{display:grid;gap:8px} .grid-4{grid-template-columns:2fr 2fr 2fr 160px} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse} .table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.table tbody tr:nth-child(2n){background:var(--table-stripe)}
.badge{padding:4px 8px;border-radius:999px;background:#12233b;color:#93c5fd;font-size:12px;border:1px solid #1f3455}
html[data-theme="light"] .badge{background:#e6f0ff;color:#1b3a74;border-color:#cfe0ff}
.pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px}
.nowrap{white-space:nowrap} a.link{color:#93c5fd;text-decoration:none} html[data-theme="light"] a.link{color:#1f52ff}
.progress{height:6px;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden} .progress > div{height:100%;background:var(--accent);width:0%}
tr.working{background:#065f4633} tr.closed{opacity:.6}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#0d1730;color:#cfe6ff}
html[data-theme="light"] .tab{background:#eaf2ff;color:#14365d} .tab.active{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.hidden{display:none} .badge-stage{padding:2px 8px;border-radius:999px;border:1px solid #2b3b4f;background:#152232;font-size:12px}
.btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.loading{position:relative}
.btn.loading::after{content:'';position:absolute;right:10px;top:50%;width:12px;height:12px;margin-top:-6px;border-radius:50%;border:2px solid rgba(255,255,255,.5);border-top-color:transparent;animation:akilovSpin .8s linear infinite}
@keyframes akilovSpin{to{transform:rotate(360deg)}} .btn.success{background:#16a34a!important;color:#05240f!important} .btn.error{background:#b91c1c!important;color:#2a0b0b!important}
.theme-toggle{margin-left:auto;display:flex;align-items:center;gap:8px} .switch{position:relative;width:52px;height:28px;border-radius:999px;border:1px solid var(--border);background:transparent;cursor:pointer}
.switch .knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:var(--text);transition:left .18s}
html[data-theme="light"] .switch .knob{left:26px} .switch .icon{font-size:12px;position:absolute;top:6px;color:#9da6b5} .switch .sun{left:8px} .switch .moon{right:8px}
.map { width:100%; height:560px; border:1px solid var(--border); border-radius:16px; background:transparent }
.badge-closed{padding:2px 6px;border-radius:8px;background:#3a2430;border:1px solid #6b2b43;color:#f6b0c3;font-size:11px}
</style>
</head>
<body>
<div class="container">
  <div class="row" style="margin-bottom:8px">
    <div class="tabs" style="margin:0">
      <div class="tab active" id="tabSearch">Search</div>
      <div class="tab" id="tabCrm">CRM</div>
      <div class="tab" id="tabWorking">Working</div>
      <div class="tab" id="tabMaps">Maps</div>
    </div>
    <div class="theme-toggle" title="Light / Dark">
      <span class="small">Theme</span>
      <div id="themeSwitch" class="switch" role="button" aria-label="Toggle theme">
        <span class="icon sun">‚òÄÔ∏è</span><span class="icon moon">üåô</span><div class="knob"></div>
      </div>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="panelSearch">
    <div class="card">
      <h2>Live Search / Library (Cached)</h2>
      <div class="grid grid-4" style="margin-top:8px">
        <select class="input select" id="category">
          <optgroup label="Judaica"><option value="__JUDAICA_ALL__">Judaica (All)</option></optgroup>
          <optgroup label="Home & Furniture">
            <option>home decor store</option><option>furniture store</option><option>lighting store</option>
            <option>art gallery</option><option>wallpaper store</option>
          </optgroup>
          <optgroup label="Kitchen & Tabletop">
            <option>housewares store</option><option>kitchen supply store</option>
            <option>tableware store</option><option>cookware store</option><option>kitchen accessories</option>
          </optgroup>
          <optgroup label="Gifts & Lifestyle">
            <option>gift shop</option><option>lifestyle store</option><option>concept store</option><option>department store home</option>
          </optgroup>
          <optgroup label="Wholesalers & Distributors">
            <option>home decor wholesaler</option><option>gift wholesaler</option>
            <option>furniture distributor</option><option>general merchandise wholesaler</option><option>buying office</option>
          </optgroup>
          <optgroup label="Designers & Trade">
            <option>interior design studio</option><option>interior designer</option><option>home staging company</option>
            <option>architecture firm</option><option>showroom</option>
          </optgroup>
        </select>

        <select class="input select" id="country">
          <optgroup label="Core"><option>Israel</option><option>USA</option></optgroup>
          <optgroup label="Europe"><option>United Kingdom</option><option>France</option><option>Germany</option><option>Italy</option><option>Netherlands</option><option>Sweden</option><option>Spain</option><option>Switzerland</option></optgroup>
          <optgroup label="Middle East"><option>United Arab Emirates</option></optgroup>
        </select>

        <select class="input select" id="scope" disabled>
          <option value="__ALL__">All country (no scope)</option>
        </select>

        <button class="btn primary" id="run">Sync Now</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideBrands" checked> Hide brand/D2C</label>
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideCrmLeads"> Hide leads already in CRM</label>
        <label class="row small" style="gap:6px"><input type="checkbox" id="showClosed"> Include closed</label>
        <button class="btn" id="enrichBtn">Enrich contacts</button>
        <button class="btn" id="exportCsv">Export CSV</button>
        <label class="row small" style="gap:6px;margin-left:auto"><input type="checkbox" id="autoSync"> Auto-sync on load</label>
      </div>
      <div class="small" style="margin-top:6px">◊§◊™◊ó ◊¢◊ù ?key=YOUR_GOOGLE_API_KEY</div>
    </div>

    <div class="card">
      <table class="table">
        <thead><tr>
          <th>Actions</th><th>Name</th><th>Location</th><th>Rating ‚òÖ</th><th class="nowrap">Reviews</th>
          <th>Phone</th><th>Website</th><th>Status</th><th>Emails</th><th>Social</th><th>Categories</th><th>CRM</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="status" class="small" style="margin-top:8px"></div>
      <div class="progress" id="prog" style="display:none;margin-top:8px"><div></div></div>
      <button class="btn" id="loadMore" disabled style="margin-top:8px">Load more</button>
    </div>
  </div>

  <!-- CRM -->
  <div id="panelCrm" class="hidden">
    <div class="card">
      <h2>CRM</h2>
      <div class="row small">
        <span>Stages:</span>
        <span class="badge-stage">New</span>
        <span class="badge-stage">Contacted</span>
        <span class="badge-stage">Qualified</span>
        <span class="badge-stage">Negotiation</span>
        <span class="badge-stage">Won</span>
        <span class="badge-stage">Lost</span>
      </div>
    </div>
    <div class="card">
      <table class="table">
        <thead><tr>
          <th>Actions</th><th>Name</th><th>Stage</th><th>Email</th><th>Phone</th><th>Website</th><th>Notes</th><th>Updated</th>
        </tr></thead>
        <tbody id="tbodyCrm"></tbody>
      </table>
      <div id="statusCrm" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- WORKING -->
  <div id="panelWorking" class="hidden">
    <div class="card">
      <h2>Working (All)</h2>
      <div class="row">
        <input class="input" id="workingSearch" placeholder="Search by name/country/city‚Ä¶" style="max-width:340px">
      </div>
    </div>
    <div class="card">
      <table class="table">
        <thead><tr><th>Actions</th><th>Name</th><th>Location</th><th>Country</th><th>Google</th></tr></thead>
        <tbody id="tbodyWorking"></tbody>
      </table>
      <div id="statusWorking" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- MAPS -->
  <div id="panelMaps" class="hidden">
    <div class="card">
      <h2>Maps ‚Äì Working (green pins)</h2>
      <div id="map" class="map"></div>
      <div id="statusMap" class="small" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const API_BASE = 'https://akilov-leads.vercel.app';
const qs = new URLSearchParams(location.search);
const GOOGLE_KEY = qs.get('key') || '';
const JUDAICA_PACK = [
  'judaica store','jewish gift shop','jewish bookstore','jewish art gallery','synagogue gift shop',
  'judaica wholesaler','jewish gift wholesaler','jewish religious items distributor','synagogue supplies wholesaler'
];
const BRAND_WORDS = ['official','brand','factory','outlet','warehouse','headquarters','corp','corporate'];
let PLACES_SERVICE=null, NEXT_PAGE=null;

/* ====== THEME ====== */
const theme = localStorage.getItem('ak_theme') || 'dark';
document.documentElement.setAttribute('data-theme', theme);
document.getElementById('themeSwitch').onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme', cur);
  localStorage.setItem('ak_theme', cur);
};

/* ====== TABS ====== */
const panels={ Search:'panelSearch', Crm:'panelCrm', Working:'panelWorking', Maps:'panelMaps' };
function activateTab(id){
  for(const el of document.querySelectorAll('.tab')) el.classList.remove('active');
  for(const p of Object.values(panels)) document.getElementById(p).classList.add('hidden');
  document.getElementById('tab'+id).classList.add('active');
  document.getElementById(panels[id]).classList.remove('hidden');
  if(id==='Maps') renderMap();
  if(id==='Crm') loadCrm();
  if(id==='Working') renderWorking();
}
document.getElementById('tabSearch').onclick=()=>activateTab('Search');
document.getElementById('tabCrm').onclick=()=>activateTab('Crm');
document.getElementById('tabWorking').onclick=()=>activateTab('Working');
document.getElementById('tabMaps').onclick=()=>activateTab('Maps');

/* ====== SCOPE OPTIONS (USA states / Israel cities) ====== */
const USA_STATES=['New York','California','Florida','Texas','Illinois','New Jersey','Massachusetts','Pennsylvania','Georgia','Washington','Ohio','Virginia','Arizona','Colorado'];
const IL_CITIES=['Tel Aviv','Jerusalem','Haifa','Rishon LeZion','Petah Tikva','Ashdod','Netanya','Beersheba','Holon','Bnei Brak','Ramat Gan','Rehovot','Bat Yam','Ashkelon','Herzliya','Kfar Saba','Ra\'anana','Givatayim','Hod HaSharon','Modiin','Beit Shemesh'];
const countrySel=document.getElementById('country'), scopeSel=document.getElementById('scope');
function refreshScope(){
  const c=countrySel.value;
  scopeSel.innerHTML='';
  let opts=[];
  if(c==='USA'){ opts=USA_STATES.map(s=>({v:s,label:s+' (state)'})); }
  else if(c==='Israel'){ opts=IL_CITIES.map(s=>({v:s,label:s})); }
  else { scopeSel.disabled=true; scopeSel.innerHTML='<option value="__ALL__">All country (no scope)</option>'; return; }
  scopeSel.disabled=false; scopeSel.appendChild(new Option('All country (no scope)','__ALL__'));
  for(const o of opts) scopeSel.appendChild(new Option(o.label,o.v));
}
countrySel.onchange=refreshScope; refreshScope();

/* ====== GOOGLE PLACES JS ====== */
function loadGoogle(){
  if(!GOOGLE_KEY) return Promise.reject(new Error('Missing Google API Key (?key=...)'));
  if(window.google?.maps?.places) { PLACES_SERVICE = new google.maps.places.PlacesService(document.createElement('div')); return Promise.resolve(); }
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places`;
    s.async=true; s.onload=()=>{ PLACES_SERVICE=new google.maps.places.PlacesService(document.createElement('div')); res(); };
    s.onerror=()=>rej(new Error('Failed to load Google Maps JS'));
    document.head.appendChild(s);
  });
}

/* ====== STATE ====== */
let CRM_STATE={ leads:[], working:[] };
let CURRENT_ROWS=[]; // rows shown in search table

/* ====== HELPERS ====== */
const statusEl=document.getElementById('status'), prog=document.getElementById('prog'), progBar=prog.firstElementChild;
function setStatus(t){ statusEl.textContent=t||''; }
function setBtnLoading(btn, on){ btn.classList.toggle('loading',!!on); btn.disabled=!!on; }
function scoreIsBrand(name){ const s=(name||'').toLowerCase(); return BRAND_WORDS.some(w=>s.includes(w)); }
function gmapsLink(name,address){ return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((name||'')+' '+(address||''))}`; }
function websiteLink(u){ try{ const url=new URL(u); return `<a class="link" href="${url.toString()}" target="_blank" rel="noopener">${url.hostname.replace('www.','')}</a>`; }catch{return '';} }

/* ====== API ====== */
async function api(path, opts){ const r=await fetch(API_BASE+path, opts); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
async function loadCrm(){ const j=await api('/api/crm'); CRM_STATE.leads=j.leads||[]; CRM_STATE.working=j.working||[]; renderCrm(); renderWorking(); }

/* ====== ENRICH PIPE (Details + Emails/Social) ====== */
async function fetchPlaceDetails(placeId){
  return new Promise((resolve)=>{
    PLACES_SERVICE.getDetails(
      { placeId, fields:['website','formatted_phone_number','international_phone_number'] },
      (det, st)=>{
        if(st===google.maps.places.PlacesServiceStatus.OK && det){
          resolve({
            website: det.website || '',
            phone: det.international_phone_number || det.formatted_phone_number || ''
          });
        } else { resolve({ website:'', phone:'' }); }
      }
    );
  });
}
async function enrichWebsite(url){
  if(!url) return { email:null, enrich_emails:null, enrich_socials:null };
  try{
    const j = await api('/api/enrich?url='+encodeURIComponent(url));
    return { email: j.best_email||null, enrich_emails: j.emails_ranked||null, enrich_socials: j.socials||null };
  }catch{ return { email:null, enrich_emails:null, enrich_socials:null }; }
}
async function attachDetailsAndEnrich(items){
  // concurrency limiter
  const limit = 4; let i=0;
  const out = new Array(items.length);
  async function worker(){
    while(i < items.length){
      const idx = i++; const it = items[idx];
      try{
        const det = await fetchPlaceDetails(it.place_id);
        it.website = it.website || det.website;
        it.phone   = it.phone   || det.phone;
        if(it.website){
          const enr = await enrichWebsite(it.website);
          it.email = enr.email || it.email || null;
          it.enrich_emails  = enr.enrich_emails || it.enrich_emails || null;
          it.enrich_socials = enr.enrich_socials || it.enrich_socials || null;
        }
      }catch(_){}
      out[idx]=it;
      // progress bar update (if visible)
      if(prog.style.display!=='none'){
        const done = out.filter(Boolean).length;
        progBar.style.width = ((done/items.length)*100)+'%';
      }
    }
  }
  await Promise.all(new Array(limit).fill(0).map(worker));
  return out;
}

/* ====== RENDER SEARCH TABLE ====== */
const tbody=document.getElementById('tbody');
function renderRows(rows){
  tbody.innerHTML='';
  const hideBrands=document.getElementById('hideBrands').checked;
  const hideCrm=document.getElementById('hideCrmLeads').checked;
  const showClosed=document.getElementById('showClosed').checked;
  const crmIds=new Set((CRM_STATE.leads||[]).map(x=>x.place_id));
  for(const it of rows){
    if(hideBrands && scoreIsBrand(it.name)) continue;
    if(hideCrm && crmIds.has(it.place_id)) continue;
    if(!showClosed && (it.business_status||'').toUpperCase().includes('CLOSED')) continue;

    const tr=document.createElement('tr');
    if((CRM_STATE.working||[]).some(w=>w.place_id===it.place_id && w.is_working)) tr.classList.add('working');
    if((it.business_status||'').toUpperCase().includes('CLOSED')) tr.classList.add('closed');

    const aGoogle = `<a class="btn" href="${gmapsLink(it.name,it.address)}" target="_blank">Google</a>`;
    const aWebsite = websiteLink(it.website);
    const rating = (typeof it.rating==='number' ? it.rating.toFixed(1) : '');
    const reviews = (typeof it.reviews==='number' ? it.reviews : '');

    const emails = (it.enrich_emails?.map?.(e=>e.email)|| it.email ? [it.email] : []).slice(0,2).join(', ');
    const socials = it.enrich_socials ? Object.values(it.enrich_socials).slice(0,1).map(u=>`<a class="link" href="${u}" target="_blank">link</a>`).join('') : '';

    const workingBtn = `<button class="btn btn-working" data-id="${it.place_id}">Working</button>`;
    const crmBtn = `<button class="btn btn-addcrm" data-id="${it.place_id}">Add to CRM</button>`;
    const enrichBtn = it.website ? `<button class="btn btn-enrich" data-id="${it.place_id}">Enrich</button>` : `<button class="btn" disabled>Enrich</button>`;

    tr.innerHTML = `
      <td class="nowrap">${aGoogle} ${enrichBtn} ${workingBtn} ${crmBtn}</td>
      <td>${it.name||''}</td>
      <td class="small">${(it.address||'').split(',').slice(0,2).join(', ')}</td>
      <td>${rating?`<span class="badge">${rating}</span>`:''}</td>
      <td>${reviews||''}</td>
      <td class="small">${it.phone||''}</td>
      <td>${aWebsite||''}</td>
      <td>${it.business_status?`<span class="badge-closed">${it.business_status}</span>':''}</td>
      <td class="small">${emails||''}</td>
      <td>${socials||''}</td>
      <td class="small">${it.categories||''}</td>
      <td class="small">${crmIds.has(it.place_id)?'<span class="badge">in CRM</span>':''}</td>
    `;
    tr.dataset.row = JSON.stringify(it);
    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = `${tbody.children.length} rows`;
  bindRowButtons();
}
function bindRowButtons(){
  for(const b of document.querySelectorAll('.btn-enrich')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row?.website) return;
    setBtnLoading(e.currentTarget,true);
    try{
      const j=await api('/api/enrich?url='+encodeURIComponent(row.website));
      row.email = j.best_email || row.email || null;
      row.enrich_emails = j.emails_ranked || null;
      row.enrich_socials = j.socials || null;
      CURRENT_ROWS = CURRENT_ROWS.map(x=>x.place_id===id?{...x,...row}:x);
      renderRows(CURRENT_ROWS);
      // save to library immediately
      await api('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        op:'upsert_many', query: currentQueryObj(), items:[row]
      })});
    }catch(err){ alert('Enrich failed'); }
    finally{ setBtnLoading(e.currentTarget,false); }
  };

  for(const b of document.querySelectorAll('.btn-working')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row) return;
    const isOn = !(CRM_STATE.working||[]).some(w=>w.place_id===id && w.is_working);
    setBtnLoading(e.currentTarget,true);
    try{
      await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        op:'set_working', place_id:id, value:isOn, name:row.name, address:row.address, lat:row.lat, lng:row.lng, country:row.country
      })});
      await loadCrm();
      renderRows(CURRENT_ROWS);
    }catch(err){ alert('Working toggle failed'); }
    finally{ setBtnLoading(e.currentTarget,false); }
  };

  for(const b of document.querySelectorAll('.btn-addcrm')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row) return;
    setBtnLoading(e.currentTarget,true);
    try{
      const payload = {
        place_id: row.place_id, name: row.name, address: row.address, website: row.website, phone: row.phone,
        rating: row.rating, reviews: row.reviews, categories: row.categories,
        email: row.email || null, enrich_emails: row.enrich_emails || null, enrich_socials: row.enrich_socials || null
      };
      await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'add_or_update_lead', lead:payload})});
      await loadCrm();
      renderRows(CURRENT_ROWS);
    }catch(err){ alert('Add to CRM failed'); }
    finally{ setBtnLoading(e.currentTarget,false); }
  };
}
function findRow(id){ for(const r of CURRENT_ROWS) if(r.place_id===id) return r; return null; }

/* ====== EXPORT CSV ====== */
document.getElementById('exportCsv').onclick=()=>{
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>JSON.parse(tr.dataset.row||'{}'));
  const cols=['place_id','name','address','country','phone','website','rating','reviews','categories','business_status','email'];
  const csv=[cols.join(',')].concat(rows.map(r=>cols.map(k=>JSON.stringify(r[k]??'')).join(','))).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='akilov_export.csv'; a.click();
};

/* ====== ENRICH BATCH (manual button) ====== */
document.getElementById('enrichBtn').onclick=async()=>{
  const btn=document.getElementById('enrichBtn'); setBtnLoading(btn,true); prog.style.display='block';
  try{
    const rows=[...tbody.querySelectorAll('tr')].map(tr=>JSON.parse(tr.dataset.row||'{}')).filter(r=>r.website);
    progBar.style.width='0%';
    let done=0;
    for(const r of rows){
      try{
        const j=await api('/api/enrich?url='+encodeURIComponent(r.website));
        r.email = j.best_email || r.email || null;
        r.enrich_emails = j.emails_ranked || null;
        r.enrich_socials = j.socials || null;
        CURRENT_ROWS = CURRENT_ROWS.map(x=>x.place_id===r.place_id?{...x,...r}:x);
        // save incrementally
        await api('/api/search',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
          op:'upsert_many', query: currentQueryObj(), items:[r]
        })});
      }catch(_){}
      done++; progBar.style.width=((done/rows.length)*100)+'%';
    }
    renderRows(CURRENT_ROWS);
  }finally{ setBtnLoading(btn,false); setTimeout(()=>{prog.style.display='none'; progBar.style.width='0%';},400); }
};

/* ====== QUERY OBJECT HELPER ====== */
function currentQueryObj(){
  const category=document.getElementById('category').value;
  return {
    category: (category==='__JUDAICA_ALL__') ? JUDAICA_PACK[0] : category,
    country: countrySel.value,
    scope: scopeSel.disabled?'__ALL__':scopeSel.value
  };
}

/* ====== SYNC NOW (Load from library + Google refresh with enrich) ====== */
document.getElementById('run').onclick=runSync;
document.getElementById('hideBrands').onchange=()=>renderRows(CURRENT_ROWS);
document.getElementById('hideCrmLeads').onchange=()=>renderRows(CURRENT_ROWS);
document.getElementById('showClosed').onchange=()=>renderRows(CURRENT_ROWS);
document.getElementById('loadMore').onclick=()=> { if (NEXT_PAGE) NEXT_PAGE(); };

async function runSync(){
  const btn=document.getElementById('run'); setBtnLoading(btn,true); setStatus('Loading from library‚Ä¶');
  await loadCrm();
  const category=document.getElementById('category').value;
  const country=countrySel.value;
  const scope=scopeSel.disabled?'__ALL__':scopeSel.value;

  // 1) Load from Library (cached)
  let libRows=[];
  const cats = (category==='__JUDAICA_ALL__') ? JUDAICA_PACK : [category];
  for(const cat of cats){
    try{
      const j=await api(`/api/search?category=${encodeURIComponent(cat)}&country=${encodeURIComponent(country)}&scope=${encodeURIComponent(scope)}`);
      libRows = libRows.concat(j.places||[]);
    }catch(_){}
  }
  // dedupe by place_id
  const seen=new Set(); libRows=libRows.filter(x=>!seen.has(x.place_id) && seen.add(x.place_id));
  CURRENT_ROWS=libRows; renderRows(CURRENT_ROWS);
  setStatus(`Loaded ${libRows.length} from library. Refreshing via Google (with enrich)‚Ä¶`);
  document.getElementById('loadMore').disabled=true; NEXT_PAGE=null;

  // 2) Live refresh via Google (first page)
  try{
    await loadGoogle();
    const qBase = (scope==='__ALL__') ? `${cats[0]} in ${country}` : `${cats[0]} in ${scope}, ${country}`;
    await googleFetchAndUpsertWithEnrich(qBase);
    setStatus('Sync complete (Google refreshed, enriched & saved).');
  }catch(e){ setStatus('Google refresh skipped: '+e.message); }
  finally{ setBtnLoading(btn,false); }
}

async function googleFetchAndUpsertWithEnrich(query){
  prog.style.display='block'; progBar.style.width='0%';
  return new Promise((resolve,reject)=>{
    PLACES_SERVICE.textSearch({ query, type:['store'] }, async (results, status, pagination)=>{
      if(status!==google.maps.places.PlacesServiceStatus.OK && status!==google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
        prog.style.display='none'; return reject(new Error(status));
      }
      const items=(results||[]).map(it=>({
        place_id: it.place_id, name: it.name, address: it.formatted_address||'',
        country: (it.formatted_address||'').split(',').pop()?.trim()||'',
        phone: '', website: '',
        rating: typeof it.rating==='number'?it.rating:null,
        reviews: typeof it.user_ratings_total==='number'?it.user_ratings_total:null,
        categories: (it.types||[]).slice(0,4).join(', '),
        business_status: it.business_status||'OPERATIONAL',
        lat: it.geometry?.location?.lat?.()||null, lng: it.geometry?.location?.lng?.()||null
      }));

      // ‚ú® Details + Enrich before saving
      const enriched = await attachDetailsAndEnrich(items);

      // Save to library
      try{
        await api('/api/search',{ method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ op:'upsert_many', query: currentQueryObj(), items: enriched }) });
      }catch(_){}

      // Merge & render
      const map=new Map(CURRENT_ROWS.map(x=>[x.place_id,x]));
      for(const it of enriched){ map.set(it.place_id,{...map.get(it.place_id),...it}); }
      CURRENT_ROWS = Array.from(map.values());
      renderRows(CURRENT_ROWS);

      // Setup pagination (same callback will fire on nextPage)
      NEXT_PAGE = pagination?.hasNextPage ? ()=>pagination.nextPage() : null;
      document.getElementById('loadMore').disabled = !NEXT_PAGE;

      // Hide progress if no pagination
      if(!NEXT_PAGE){ setTimeout(()=>{prog.style.display='none'; progBar.style.width='0%';},300); }
      resolve();
    });
  });
}

/* ====== CRM RENDER & ACTIONS ====== */
const tbodyCrm=document.getElementById('tbodyCrm');
function renderCrm(){
  tbodyCrm.innerHTML='';
  for(const lead of (CRM_STATE.leads||[])){
    const tr=document.createElement('tr');
    const stageSel = `
      <select class="input select sel-stage" data-id="${lead.id}">
        ${['New','Contacted','Qualified','Negotiation','Won','Lost'].map(s=>`<option ${lead.stage===s?'selected':''}>${s}</option>`).join('')}
      </select>`;
    tr.innerHTML=`
      <td class="nowrap">
        <a class="btn" href="${gmapsLink(lead.name, lead.address)}" target="_blank">Open</a>
        <button class="btn btn-del" data-id="${lead.id}">Delete</button>
      </td>
      <td>${lead.name||''}</td>
      <td>${stageSel}</td>
      <td class="small">${lead.email||''}</td>
      <td class="small">${lead.phone||''}</td>
      <td>${websiteLink(lead.website)||''}</td>
      <td>
        <div class="row" style="gap:6px">
          <input class="input inp-note" data-id="${lead.id}" placeholder="Add note‚Ä¶" style="width:240px">
          <button class="btn btn-note" data-id="${lead.id}">Save</button>
        </div>
        <div class="small" style="white-space:pre-wrap;margin-top:6px">${lead.notes||''}</div>
      </td>
      <td class="small">${(lead.updated_at||'').toString().replace('T',' ').slice(0,19)}</td>
    `;
    tbodyCrm.appendChild(tr);
  }
  document.getElementById('statusCrm').textContent = `${(CRM_STATE.leads||[]).length} leads`;
  // bind:
  for(const s of tbodyCrm.querySelectorAll('.sel-stage')) s.onchange = async (e)=>{
    const id=e.target.dataset.id, stage=e.target.value;
    await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'set_stage', lead_id:id, stage})});
    await loadCrm();
  };
  for(const b of tbodyCrm.querySelectorAll('.btn-note')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id;
    const input=tbodyCrm.querySelector(`.inp-note[data-id="${id}"]`); const note=input.value.trim(); if(!note) return;
    await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'add_note', lead_id:id, note})});
    input.value=''; await loadCrm();
  };
  for(const b of tbodyCrm.querySelectorAll('.btn-del')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; if(!confirm('Delete lead?')) return;
    await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'delete_lead', lead_id:id})});
    await loadCrm();
  };
}

/* ====== WORKING TAB ====== */
const tbodyWorking=document.getElementById('tbodyWorking');
function renderWorking(){
  const q=(document.getElementById('workingSearch').value||'').toLowerCase();
  tbodyWorking.innerHTML='';
  for(const w of (CRM_STATE.working||[]).filter(x=>x.is_working)){
    if(q && !(`${w.name} ${w.address} ${w.country}`.toLowerCase().includes(q))) continue;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="nowrap">
        <button class="btn btn-wk-off" data-id="${w.place_id}">Remove</button>
      </td>
      <td>${w.name||''}</td>
      <td class="small">${w.address||''}</td>
      <td>${w.country||''}</td>
      <td><a class="btn" href="${gmapsLink(w.name,w.address)}" target="_blank">Google</a></td>
    `;
    tbodyWorking.appendChild(tr);
  }
  document.getElementById('statusWorking').textContent = `${tbodyWorking.children.length} working`;
  for(const b of tbodyWorking.querySelectorAll('.btn-wk-off')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id;
    await api('/api/crm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'set_working', place_id:id, value:false})});
    await loadCrm(); renderRows(CURRENT_ROWS);
  };
}
document.getElementById('workingSearch').oninput=()=>renderWorking();

/* ====== MAPS (WORKING) ====== */
let MAP=null, MARKERS=[];
async function renderMap(){
  if(!GOOGLE_KEY){ document.getElementById('statusMap').textContent='Open with ?key=YOUR_GOOGLE_API_KEY to view the map.'; return; }
  await loadGoogle();
  const el=document.getElementById('map');
  if(!MAP){ MAP=new google.maps.Map(el,{center:{lat:31.4,lng:34.9},zoom:2,mapTypeControl:false,streetViewControl:false}); }
  for(const m of MARKERS){ m.setMap(null); }
  MARKERS.length=0;
  const items=(CRM_STATE.working||[]).filter(x=>x.is_working && typeof x.lat==='number' && typeof x.lng==='number');
  for(const it of items){
    const m=new google.maps.Marker({ position:{lat:it.lat,lng:it.lng}, map:MAP, title:it.name });
    const inf=new google.maps.InfoWindow({ content:`<div><b>${it.name||''}</b><div class="small">${it.address||''}</div><a href="${gmapsLink(it.name,it.address)}" target="_blank">Open in Maps</a></div>` });
    m.addListener('click',()=>inf.open({anchor:m,map:MAP}));
    MARKERS.push(m);
  }
  if(items[0]) MAP.setCenter({lat:items[0].lat,lng:items[0].lng});
  document.getElementById('statusMap').textContent=`${items.length} pins`;
}

/* ====== AUTO SYNC ON LOAD ====== */
try{ document.getElementById('autoSync').checked = localStorage.getItem('ak_auto')==='1'; }catch{}
document.getElementById('autoSync').onchange=()=>localStorage.setItem('ak_auto', document.getElementById('autoSync').checked?'1':'0');
window.addEventListener('load', async ()=>{
  try{ await loadCrm(); }catch(_){}
  if(document.getElementById('autoSync').checked){ runSync(); }
});
</script>
</body>
</html>
