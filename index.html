<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AKILOV – Leads Search + Enrich + CRM</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--accent:#0ea5a6;--ok:#0f3d2e;--ok-border:#1a5e47}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1240px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
h2{margin:0 0 8px 0}
.small{font-size:12px;color:var(--muted)}
.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
.select{appearance:none}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;cursor:pointer;font-size:13px;transition:transform .05s}
.btn.primary{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.grid{display:grid;gap:8px}
.grid-3{grid-template-columns:2fr 2fr 160px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.badge{padding:4px 8px;border-radius:999px;background:#12233b;color:#93c5fd;font-size:12px;border:1px solid #1f3455}
.pill{border:1px solid #1f2937;border-radius:999px;padding:4px 10px}
.range{accent-color:#0ea5a6}
.nowrap{white-space:nowrap}
a.link{color:#93c5fd;text-decoration:none}
.progress{height:6px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:#0ea5a6;width:0%}
tr.working{background:#065f4633}
tr.working td{border-bottom-color:#1a5e47}
.legend{display:flex;align-items:center;gap:6px}
.legend .chip{width:12px;height:12px;background:var(--ok);border:1px solid var(--ok-border);border-radius:3px;display:inline-block}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#0d1730}
.tab.active{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.hidden{display:none}
.badge-stage{padding:2px 8px;border-radius:999px;border:1px solid #2b3b4f;background:#152232;font-size:12px}

/* Feedback */
.btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.loading{position:relative}
.btn.loading::after{content:'';position:absolute;right:10px;top:50%;width:12px;height:12px;margin-top:-6px;border-radius:50%;border:2px solid rgba(255,255,255,.5);border-top-color:transparent;animation:akilovSpin .8s linear infinite}
@keyframes akilovSpin{to{transform:rotate(360deg)}} .btn.success{background:#16a34a!important;color:#05240f!important} .btn.error{background:#b91c1c!important;color:#2a0b0b!important}

/* CRM rows */
tr.stage-Won{background:#0f3d2e40} tr.stage-Lost{background:#3d0f0f40}
</style>
</head>
<body>
<div class="container">
  <div class="tabs"><div class="tab active" id="tabSearch">Search</div><div class="tab" id="tabCrm">CRM</div></div>

  <!-- SEARCH -->
  <div id="panelSearch">
    <div class="card">
      <h2>Live Search – Retailers / Wholesalers</h2>
      <div class="grid grid-3" style="margin-top:8px">
        <select class="input select" id="category">
          <optgroup label="Judaica">
            <option value="__JUDAICA_ALL__">Judaica (All)</option>
          </optgroup>
          <optgroup label="Home & Furniture">
            <option>home decor store</option><option>furniture store</option><option>lighting store</option>
            <option>art gallery</option><option>wallpaper store</option>
          </optgroup>
          <optgroup label="Kitchen & Tabletop">
            <option>housewares store</option><option>kitchen supply store</option>
            <option>tableware store</option><option>cookware store</option><option>kitchen accessories</option>
          </optgroup>
          <optgroup label="Gifts & Lifestyle">
            <option>gift shop</option><option>lifestyle store</option><option>concept store</option><option>department store home</option>
          </optgroup>
          <optgroup label="Wholesalers & Distributors">
            <option>home decor wholesaler</option><option>gift wholesaler</option>
            <option>furniture distributor</option><option>general merchandise wholesaler</option><option>buying office</option>
          </optgroup>
          <optgroup label="Designers & Trade">
            <option>interior design studio</option><option>interior designer</option><option>home staging company</option>
            <option>architecture firm</option><option>showroom</option>
          </optgroup>
        </select>
        <select class="input select" id="region">
          <optgroup label="USA">
            <option>New York, USA</option><option>Los Angeles, USA</option><option>Miami, USA</option>
            <option>Chicago, USA</option><option>Dallas, USA</option><option>San Francisco, USA</option>
            <option>Houston, USA</option><option>Seattle, USA</option><option>Atlanta, USA</option><option>Boston, USA</option>
          </optgroup>
          <optgroup label="Europe">
            <option>London, UK</option><option>Paris, France</option><option>Berlin, Germany</option>
            <option>Milan, Italy</option><option>Amsterdam, Netherlands</option><option>Stockholm, Sweden</option>
            <option>Madrid, Spain</option><option>Barcelona, Spain</option><option>Zurich, Switzerland</option>
          </optgroup>
          <optgroup label="Middle East">
            <option>Tel Aviv, Israel</option><option>Dubai, UAE</option>
          </optgroup>
        </select>
        <button class="btn primary" id="run">Live Search</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideBrands" checked> Hide brand/D2C</label>
        <span class="pill small">Min Rating: <span id="ratingVal">4.0</span> ★</span>
        <input type="range" id="minRating" class="range" min="3.0" max="5.0" step="0.1" value="4.0" style="width:220px">
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideCrmLeads" checked> Hide leads already in CRM (stage ≠ New)</label>
        <button class="btn" id="enrichBtn">Enrich contacts</button>
        <button class="btn" id="exportCsv">Export CSV</button>
      </div>
      <div class="small" style="margin-top:6px">פתח את הדף עם ?key=YOUR_GOOGLE_API_KEY</div>
    </div>

    <div class="card">
      <table class="table">
        <thead><tr>
          <th>Actions</th><th>Name</th><th>Location</th><th>Rating ★</th><th class="nowrap">Reviews</th>
          <th>Phone</th><th>Website</th><th>Open</th><th>Emails</th><th>Social</th><th>Categories</th><th>CRM</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="status" class="small" style="margin-top:8px"></div>
      <div class="progress" id="prog" style="display:none;margin-top:8px"><div></div></div>
      <button class="btn" id="loadMore" disabled style="margin-top:8px">Load more</button>
    </div>
  </div>

  <!-- CRM -->
  <div id="panelCrm" class="hidden">
    <div class="card">
      <h2>CRM</h2>
      <div class="row" style="margin-top:8px">
        <button class="btn primary" id="btnRefreshCrm">Refresh</button>
        <label class="small">Stage filter:
          <select id="crmStageFilter" class="input" style="width:220px">
            <option value="ALL">All</option><option>New</option><option>Contacted</option>
            <option>Qualified</option><option>Negotiation</option><option>Won</option><option>Lost</option>
          </select>
        </label>
      </div>
    </div>
    <div class="card">
      <table class="table" id="crmTable">
        <thead><tr><th>Open</th><th>Name</th><th>Stage</th><th>Email</th><th>Phone</th><th>Website</th><th>Updated</th><th>Delete</th></tr></thead>
        <tbody id="crmBody"></tbody>
      </table>
      <div id="crmStatus" class="small" style="margin-top:8px"></div>
    </div>

    <div id="leadPanel" class="card" style="display:none">
      <h3 id="lpTitle">Lead</h3>
      <div class="row" style="margin-top:8px">
        <span class="pill small">Stage: <b id="stageVal">New</b></span>
        <select id="stageSel" class="input" style="width:220px">
          <option>New</option><option>Contacted</option><option>Qualified</option>
          <option>Negotiation</option><option>Won</option><option>Lost</option>
        </select>
        <button class="btn" id="btnSaveStage">Save stage</button>
        <button class="btn" id="btnClosePanel">Close</button>
      </div>
      <div style="margin-top:8px">
        <label class="small">Add Note:</label>
        <textarea id="noteTxt" class="input" rows="3" placeholder="שיחה, הצעת מחיר, פרטים..."></textarea>
        <div class="row" style="margin-top:8px"><button class="btn" id="btnAddNote">Add note</button></div>
      </div>
      <div class="small" id="lpNotes" style="margin-top:8px;white-space:pre-wrap"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const ENRICH_API_BASE = 'https://akilov-leads.vercel.app/api/enrich';
const CRM_API       = 'https://akilov-leads.vercel.app/api/crm';

/* ====== UI helpers ====== */
function setBusy(btn,isBusy,busyText,normalText){ if(!btn) return; if(isBusy){ btn.dataset._label=normalText??btn.textContent; if(busyText) btn.textContent=busyText; btn.classList.add('loading'); btn.setAttribute('disabled','disabled'); } else { btn.classList.remove('loading'); btn.removeAttribute('disabled'); if(btn.dataset._label) btn.textContent=btn.dataset._label; } }
function flash(btn,type='success',ms=900){ if(!btn) return; btn.classList.add(type==='error'?'error':'success'); setTimeout(()=>btn.classList.remove(type==='error'?'error':'success'),ms); }
const $=(s)=>document.querySelector(s);
function show(msg){ const el=$('#status'); console.log(msg); el.textContent=typeof msg==='string'?msg:JSON.stringify(msg); }
function setProgress(p){ const bar=$('#prog'); const fill=bar.querySelector('div'); bar.style.display='block'; fill.style.width=(Math.max(0,Math.min(100,p))+'%'); if(p>=100) setTimeout(()=>bar.style.display='none',600); }

/* ====== State ====== */
let places, lastRaw=[], detailsCache=new Map(), _pagination=null;
const qs=new URLSearchParams(location.search); const apiKey=qs.get('key');
const KEEP_TYPES=new Set(['store','home_goods_store','furniture_store','department_store','shopping_mall','lighting_store','wholesaler','distributor']);
const BLOCK_TYPES=new Set(['manufacturer','corporate_office','headquarters','factory']);
const BRAND_KEYWORDS=['official','brand','atelier','factory','manufacturer','headquarters','hq','®','™','global brand','the brand'];
let crmByPlace=new Map(), crmList=[]; let currentLead=null;

/* ====== Tabs ====== */
$('#tabSearch').onclick=(e)=>{ setActiveTab('search'); flash(e.currentTarget); };
$('#tabCrm').onclick=async (e)=>{ setActiveTab('crm'); flash(e.currentTarget); await refreshCrm(); };
function setActiveTab(which){ if(which==='crm'){ $('#tabCrm').classList.add('active'); $('#tabSearch').classList.remove('active'); $('#panelCrm').classList.remove('hidden'); $('#panelSearch').classList.add('hidden'); } else { $('#tabSearch').classList.add('active'); $('#tabCrm').classList.remove('active'); $('#panelSearch').classList.remove('hidden'); $('#panelCrm').classList.add('hidden'); } }

/* ====== Init ====== */
(async function init(){
  if(!apiKey){ show('Missing API key. Open with ?key=YOUR_GOOGLE_API_KEY'); return; }
  await loadScript(`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places`);
  places=new google.maps.places.PlacesService(document.createElement('div'));

  // Load CRM immediately so Working is known for everyone
  await refreshCrm();

  // Buttons
  $('#run').onclick=async (e)=>{ const b=e.currentTarget; setBusy(b,true,'Searching…','Live Search'); try{ await runSearch(); flash(b); }catch(err){ console.error(err); flash(b,'error'); } finally{ setBusy(b,false); } };
  $('#enrichBtn').onclick=async (e)=>{ const b=e.currentTarget; setBusy(b,true,'Enriching…','Enrich contacts'); try{ await enrichContacts(); flash(b); }catch(err){ console.error(err); flash(b,'error'); } finally{ setBusy(b,false); } };
  $('#loadMore').onclick=async (e)=>{ const b=e.currentTarget; if(!_pagination?.hasNextPage) return; setBusy(b,true,'Loading…','Load more'); try{ await new Promise(r=>setTimeout(r,150)); _pagination.nextPage(); flash(b); }catch(err){ console.error(err); flash(b,'error'); } finally{ setBusy(b,false); } };
  $('#minRating').oninput=()=>{ $('#ratingVal').textContent=parseFloat($('#minRating').value).toFixed(1); render(lastRaw); };
  $('#exportCsv').onclick=(e)=>{ setBusy(e.currentTarget,true,'Exporting…','Export CSV'); try{ exportCsv(); flash(e.currentTarget); } finally{ setBusy(e.currentTarget,false); } };

  // CRM panel
  $('#btnRefreshCrm').onclick=async (e)=>{ const b=e.currentTarget; setBusy(b,true,'Refreshing…','Refresh'); try{ await refreshCrm(); flash(b); } finally{ setBusy(b,false);} };
  $('#crmStageFilter').onchange=renderCrmTable;
  $('#btnSaveStage').onclick=async (e)=>{ const b=e.currentTarget; setBusy(b,true,'Saving…','Save stage'); try{ await saveStage(); flash(b); }catch(err){ console.error(err); flash(b,'error'); } finally{ setBusy(b,false);} };
  $('#btnAddNote').onclick=async (e)=>{ const b=e.currentTarget; setBusy(b,true,'Adding…','Add note'); try{ await addNote(); flash(b); }catch(err){ console.error(err); flash(b,'error'); } finally{ setBusy(b,false);} };
  $('#btnClosePanel').onclick=(e)=>{ flash(e.currentTarget); $('#leadPanel').style.display='none'; currentLead=null; };

  show('Ready. Search tab: choose category & region and click Live Search.');
})();

/* ====== Google calls ====== */
function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=res; s.onerror=()=>rej(new Error('Maps JS failed')); document.head.appendChild(s); }); }
function textSearchOnce(query){ return new Promise((resolve)=>{ places.textSearch({ query }, (results,status,pagination)=>{ if(status!==google.maps.places.PlacesServiceStatus.OK && status!==google.maps.places.PlacesServiceStatus.ZERO_RESULTS){ resolve({list:[],pagination:null}); return;} resolve({list:results||[],pagination}); }); }); }
async function fetchDetailsFor(list){
  const fields=['place_id','name','formatted_address','types','rating','user_ratings_total','opening_hours','international_phone_number','formatted_phone_number','website'];
  let i=0; for(const r of list){ await new Promise((resolve)=>{ places.getDetails({ placeId:r.place_id, fields }, (det,status)=>{ if(status===google.maps.places.PlacesServiceStatus.OK && det){ detailsCache.set(r.place_id,det); } resolve(); }); }); i++; if(i%5===0) await new Promise(r=>setTimeout(r,200)); setProgress((i/list.length)*100); } setProgress(100);
}

/* ====== Search flow ====== */
async function runSearch(){
  const category=$('#category').value; const region=$('#region').value;
  lastRaw=[]; _pagination=null; $('#loadMore').disabled=true; $('#tbody').innerHTML='';
  if(category==='__JUDAICA_ALL__'){
    show('Searching Judaica…');
    const terms=['judaica store','jewish gift shop','jewish bookstore','jewish art gallery','synagogue gift shop','judaica wholesaler','jewish gift wholesaler','jewish religious items distributor','jewish ceremonial wholesaler','synagogue supplies wholesaler'];
    for(const t of terms){ const {list}=await textSearchOnce(`${t} in ${region}`); lastRaw=mergeUnique(lastRaw,list); render(lastRaw); show(`Loaded ${lastRaw.length} so far…`); }
    show(`Found ${lastRaw.length}. Fetching websites…`); await fetchDetailsFor(lastRaw); render(lastRaw); show(`Ready. Found ${lastRaw.length}.`);
  }else{
    const q=`${category} in ${region}`; show('Loading…');
    places.textSearch({ query:q }, async (results,status,pagination)=>{
      if(status!==google.maps.places.PlacesServiceStatus.OK && status!==google.maps.places.PlacesServiceStatus.ZERO_RESULTS){ show('Places error: '+status); return; }
      lastRaw=results||[]; render(lastRaw);
      _pagination=(pagination&&pagination.hasNextPage)?pagination:null; $('#loadMore').disabled=!_pagination;
      if(!_pagination){ show(`Found ${lastRaw.length}. Fetching websites…`); await fetchDetailsFor(lastRaw); render(lastRaw); show(`Ready. Found ${lastRaw.length}.`); }
      else { show(`Loaded ${lastRaw.length}. Click "Load more" for more.`); }
    });
  }
}
function mergeUnique(a,b){ const seen=new Set(a.map(x=>x.place_id)); const out=a.slice(); for(const r of (b||[])){ if(!seen.has(r.place_id)){ seen.add(r.place_id); out.push(r);} } return out; }

/* ====== Enrich ====== */
async function enrichContacts(){
  if(!lastRaw.length){ show('Run a search first.'); return; }
  const withSites=lastRaw.filter(x=>(detailsCache.get(x.place_id)||{}).website).slice(0,100);
  if(!withSites.length){ show('No websites found to enrich.'); return; }
  show(`Enriching ${withSites.length} sites…`); let done=0;
  for(const r of withSites){ const det=detailsCache.get(r.place_id)||{}; try{ const resp=await fetch(ENRICH_API_BASE+'?url='+encodeURIComponent(det.website)); const data=await resp.json(); det._enrich=data; detailsCache.set(r.place_id,det);}catch(e){} done++; if(done%3===0) await new Promise(res=>setTimeout(res,150)); setProgress((done/withSites.length)*100); }
  setProgress(100); render(lastRaw); show('Enrich done.');
}

/* ====== CRM API ====== */
async function crmGet(){ const r=await fetch(CRM_API); return await r.json(); }
async function crmPost(body){ const r=await fetch(CRM_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); return await r.json(); }

/* ====== CRM Sync ====== */
async function refreshCrm(){
  const j=await crmGet(); if(!j.ok){ $('#crmStatus').textContent='CRM error: '+j.error; return; }
  crmList=j.leads||[]; crmByPlace=new Map(); for(const L of crmList){ if(L.place_id) crmByPlace.set(L.place_id,L); }
  render(lastRaw); renderCrmTable();
  $('#crmStatus').textContent=`Loaded ${crmList.length} leads.`;
}

/* ====== Render search table ====== */
function render(raw){
  const hideBrands=$('#hideBrands').checked; const minRating=parseFloat($('#minRating').value)||0; const hideCrm=$('#hideCrmLeads').checked;
  const filtered=(raw||[]).filter(it=>{
    const types=it.types||[]; if(!looksLikeRetailOrWholesale(types)) return false;
    if(hideBrands && looksLikeBrand(it.name,types)) return false;
    if(hideCrm){ const crm=crmByPlace.get(it.place_id); if(crm && crm.stage && crm.stage!=='New') return false; }
    const rating=typeof it.rating==='number'?it.rating:0; return rating>=minRating;
  });

  const tbody=$('#tbody'); tbody.innerHTML='';
  for(const it of filtered.slice(0,200)){
    const det=detailsCache.get(it.place_id)||{};
    const phone=det.international_phone_number||det.formatted_phone_number||'';
    const websiteUrl=det.website||''; const website=websiteUrl?`<a class="link" href="${websiteUrl}" target="_blank">Website</a>`:'—';
    const openNow=det.opening_hours?.open_now===true?'Open':(det.opening_hours?.open_now===false?'Closed':'—');
    const reviews=(typeof it.user_ratings_total==='number')?it.user_ratings_total:(typeof det.user_ratings_total==='number'?det.user_ratings_total:'—');
    const rating=(typeof it.rating==='number')?it.rating.toFixed(1):(typeof det.rating==='number'?det.rating.toFixed(1):'—');
    const enrich=(det._enrich||{}); const bestEmail=enrich.best_email||''; const socials=enrich.socials||{};
    const socialsHtml=[socials.linkedin?`<a class="link" href="${socials.linkedin}" target="_blank">LinkedIn</a>`:'', socials.instagram?`<a class="link" href="${socials.instagram}" target="_blank">Instagram</a>`:'', socials.facebook?`<a class="link" href="${socials.facebook}" target="_blank">Facebook</a>`:''].filter(Boolean).join(' · ');
    const crm=crmByPlace.get(it.place_id)||null; const isWorking=!!(crm && crm.is_working);

    const tr=document.createElement('tr'); if(isWorking) tr.classList.add('working');
    tr.innerHTML=`
      <td>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" onclick="toggleWorking('${it.place_id}', this)">${isWorking?'Unmark':'Working'}</button>
          <button class="btn" onclick="addToCrm('${it.place_id}', this)">${crm?'Update CRM':'Add to CRM'}</button>
        </div>
      </td>
      <td>${it.name}</td>
      <td class="small">${it.formatted_address||''}</td>
      <td class="nowrap"><span class="badge">${rating} ★</span></td>
      <td>${reviews}</td>
      <td class="small">${phone||'—'}</td>
      <td>${website||'—'}</td>
      <td>${openNow||'—'}</td>
      <td class="small nowrap">${bestEmail||'—'}</td>
      <td class="small">${socialsHtml||'—'}</td>
      <td class="small">${(it.types||[]).slice(0,3).join(', ')}</td>
      <td>${crm?`<span class="badge-stage">${crm.stage||'New'}</span>`:'—'}</td>
    `;
    tbody.appendChild(tr);
  }
  $('#counts').textContent=`Showing ${filtered.length} / ${raw?.length||0}`;
  if(!_pagination || !_pagination.hasNextPage){ $('#loadMore').disabled=true; }
}

/* ====== Working (server-synced) ====== */
async function toggleWorking(placeId, btn){
  try{
    const existing=crmByPlace.get(placeId);
    // Make sure a row exists in CRM so the state is shared
    if(!existing){ await addToCrm(placeId); }
    const after=crmByPlace.get(placeId);
    const desired = !(after && after.is_working);
    if(btn) setBusy(btn,true, desired?'Marking…':'Unmarking…', desired?'Working':'Unmark');
    const j = await crmPost({ op:'set_working', place_id: placeId, value: desired });
    if(!j.ok){ if(btn) flash(btn,'error'); alert('Working failed: '+j.error); return; }
    await refreshCrm(); render(lastRaw);
    if(btn) flash(btn,'success');
  }catch(e){
    if(btn) flash(btn,'error'); alert('Working failed: '+(e.message||e));
  }finally{
    if(btn) setBusy(btn,false);
  }
}

/* ====== CRM add/update from search ====== */
async function addToCrm(placeId, btn){
  try{
    if(btn) setBusy(btn,true,'Saving…','Add to CRM');
    const det=detailsCache.get(placeId)||{}; const enrich=det._enrich||{};
    const lead={
      place_id:placeId, name:det.name||'', address:det.formatted_address||'',
      website:det.website||'', phone:det.international_phone_number||det.formatted_phone_number||'',
      rating:det.rating??null, reviews:det.user_ratings_total??null, categories:(det.types||[]).slice(0,5).join(', '),
      email:enrich.best_email||null, enrich_emails:enrich.emails_ranked||null, enrich_socials:enrich.socials||null
    };
    const j=await crmPost({ op:'add_or_update_lead', lead });
    if(!j.ok){ if(btn) flash(btn,'error'); alert('CRM error: '+j.error); return; }
    crmByPlace.set(placeId,j.lead); await refreshCrm(); render(lastRaw); if(btn) flash(btn,'success');
  }catch(e){ if(btn) flash(btn,'error'); alert('Add to CRM failed: '+(e.message||e)); }
  finally{ if(btn) setBusy(btn,false); }
}

/* ====== CRM dashboard ====== */
function renderCrmTable(){
  const stageFilter=$('#crmStageFilter').value; const body=$('#crmBody'); body.innerHTML='';
  const list=crmList.filter(L=>stageFilter==='ALL'?true:(L.stage===stageFilter));
  for(const L of list){
    const tr=document.createElement('tr'); if(L.stage==='Won') tr.classList.add('stage-Won'); if(L.stage==='Lost') tr.classList.add('stage-Lost');
    tr.innerHTML=`
      <td><button class="btn" onclick='openLeadPanel(${JSON.stringify(L).replace(/"/g,'&quot;')}); this.blur();'>Open</button></td>
      <td>${L.name||''}</td>
      <td><span class="badge-stage">${L.stage||'New'}</span></td>
      <td class="small">${L.email||'—'}</td>
      <td class="small">${L.phone||'—'}</td>
      <td class="small">${L.website?`<a class="link" href="${L.website}" target="_blank">Website</a>`:'—'}</td>
      <td class="small">${(L.updated_at||'').replace('T',' ').slice(0,19)}</td>
      <td><button class="btn" onclick="confirmDeleteLead('${L.id}', this)">🗑 Delete</button></td>
    `;
    body.appendChild(tr);
  }
}
function openLeadPanel(L){ currentLead=L; $('#leadPanel').style.display='block'; $('#lpTitle').textContent=L.name||L.place_id||'Lead'; $('#stageVal').textContent=L.stage||'New'; $('#stageSel').value=L.stage||'New'; $('#lpNotes').textContent=L.notes||''; }
async function saveStage(){ if(!currentLead) return; const stage=$('#stageSel').value; const j=await crmPost({ op:'set_stage', lead_id: currentLead.id, stage }); if(!j.ok){ alert('Save stage failed: '+j.error); return; } currentLead=j.lead; $('#stageVal').textContent=currentLead.stage; await refreshCrm(); }
async function addNote(){ if(!currentLead) return; const note=$('#noteTxt').value.trim(); if(!note){ alert('כתוב הערה'); return; } const j=await crmPost({ op:'add_note', lead_id: currentLead.id, note }); if(!j.ok){ alert('Add note failed: '+j.error); return; } $('#noteTxt').value=''; currentLead=j.lead; $('#lpNotes').textContent=currentLead.notes||''; }
async function confirmDeleteLead(id, btn){ if(!id) return; if(!confirm('Delete this lead?')) return; try{ setBusy(btn,true,'Deleting…','🗑 Delete'); const j=await crmPost({ op:'delete_lead', lead_id:id }); if(!j.ok){ flash(btn,'error'); alert('Delete failed: '+j.error); return; } flash(btn,'success'); await refreshCrm(); }catch(e){ flash(btn,'error'); alert('Delete failed: '+(e.message||e)); } finally{ setBusy(btn,false); } }

/* ====== misc ====== */
function looksLikeBrand(name,types){ const n=(name||'').toLowerCase(); if((types||[]).some(t=>BLOCK_TYPES.has(t))) return true; return BRAND_KEYWORDS.some(k=>n.includes(k)); }
function looksLikeRetailOrWholesale(types){ const t=types||[]; return t.some(x=>KEEP_TYPES.has(x))||t.includes('point_of_interest')||t.includes('establishment'); }
</script>
</body>
</html>
