<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AKILOV Leads – Live Search + Enrich</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--accent:#0ea5a6}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1200px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111827;color:#e5e7eb;cursor:pointer}
.btn.primary{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.badge{padding:4px 8px;border-radius:999px;background:#12233b;color:#93c5fd;font-size:12px;border:1px solid #1f3455}
.small{font-size:12px;color:#9aa4b5}
.grid{display:grid;gap:8px}
.grid-3{grid-template-columns:2fr 2fr 160px}
.nowrap{white-space:nowrap}
.progress{height:6px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:#0ea5a6;width:0%}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <h2>Live Search – Retailers / Wholesalers</h2>
    <div class="grid grid-3" style="margin-top:8px">
      <select class="input" id="category">
        <option>home decor store</option>
        <option>housewares store</option>
        <option>furniture store</option>
        <option>interior design studio</option>
        <option>wholesaler home decor</option>
        <option>distributor home decor</option>
        <option>buying office</option>
        <option value="__JUDAICA_ALL__">Judaica (All)</option>
      </select>
      <select class="input" id="region">
        <option>New York, USA</option><option>Los Angeles, USA</option><option>Miami, USA</option>
        <option>London, UK</option><option>Paris, France</option><option>Berlin, Germany</option>
      </select>
      <button class="btn primary" id="run">Live Search</button>
    </div>
    <div style="margin-top:10px">
      <button class="btn" id="enrichBtn">Enrich contacts</button>
    </div>
    <div class="small" style="margin-top:6px">שימוש: פתח את העמוד עם הפרמטר ?key=YOUR_GOOGLE_API_KEY</div>
  </div>

  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Name</th><th>Location</th><th>Rating ★</th><th>Website</th><th>Emails</th><th>Categories</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="status" class="small" style="margin-top:8px"></div>
    <div class="progress" id="prog" style="display:none;margin-top:8px"><div></div></div>
  </div>
</div>

<script>
const ENRICH_API_BASE = 'https://akilov-leads.vercel.app/api/enrich'; // ה-Vercel שלך (כבר נכון)
const qs = new URLSearchParams(location.search);
const apiKey = qs.get('key');

let places, lastRaw=[], detailsCache=new Map();

function show(msg){ const el=document.getElementById('status'); console.log(msg); el.textContent = typeof msg==='string'? msg : JSON.stringify(msg) }
function setProgress(p){ const bar=document.getElementById('prog'); const fill=bar.querySelector('div'); bar.style.display='block'; fill.style.width=(Math.max(0,Math.min(100,p))+'%'); if(p>=100) setTimeout(()=> bar.style.display='none', 600); }

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script'); s.src=src; s.async=true; s.onload=resolve; s.onerror=()=>reject(new Error('Failed to load Maps JS')); document.head.appendChild(s);
  });
}

async function init(){
  if(!apiKey){ show('Missing API key. Add ?key=YOUR_GOOGLE_API_KEY to the URL.'); return; }
  await loadScript(`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places`);
  places = new google.maps.places.PlacesService(document.createElement('div'));
  document.getElementById('run').onclick = runSearch;
  document.getElementById('enrichBtn').onclick = enrichContacts;
  show('Ready. Choose category & region and click Live Search.');
}

function textSearchOnce(query){
  return new Promise((resolve)=>{
    places.textSearch({ query }, (results, status)=>{
      if(status !== google.maps.places.PlacesServiceStatus.OK && status !== google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
        resolve([]); return;
      }
      resolve(results||[]);
    });
  });
}

async function fetchDetailsFor(list){
  const fields = ['place_id','name','formatted_address','types','rating','user_ratings_total','international_phone_number','formatted_phone_number','website'];
  let i=0;
  for(const r of list){
    await new Promise((resolve)=>{
      places.getDetails({ placeId: r.place_id, fields }, (det, status)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && det){
          detailsCache.set(r.place_id, det);
        }
        resolve();
      });
    });
    i++;
    if(i%5===0) await new Promise(r=>setTimeout(r,200)); // האטה קטנה למגבלת קצב
    setProgress((i/list.length)*100);
  }
  setProgress(100);
}

function render(data){
  const tbody=document.getElementById('tbody'); tbody.innerHTML='';
  for(const it of data){
    const det = detailsCache.get(it.place_id) || {};
    const websiteUrl = det.website || '';
    const website = websiteUrl ? `<a href="${websiteUrl}" target="_blank">Website</a>` : '—';
    const enrich = det._enrich || {};
    const bestEmail = enrich.best_email || '';
    const cats = (it.types||[]).slice(0,3).join(', ');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${it.name}</td>
      <td class="small">${it.formatted_address||''}</td>
      <td><span class="badge">${typeof it.rating==='number'? it.rating.toFixed(1): (det.rating?det.rating.toFixed(1):'—')} ★</span></td>
      <td class="small">${website}</td>
      <td class="small nowrap">${bestEmail || '—'}</td>
      <td class="small">${cats}</td>
    `;
    tbody.appendChild(tr);
  }
}

async function runSearch(){
  const category = document.getElementById('category').value;
  const region = document.getElementById('region').value;

  // "Judaica (All)" מריץ כמה חיפושים ומאחד
  let results=[];
  if(category === '__JUDAICA_ALL__'){
    const terms = [
      'judaica store','jewish gift shop','jewish bookstore','jewish art gallery','synagogue gift shop',
      'judaica wholesaler','jewish gift wholesaler','jewish religious items distributor','jewish ceremonial wholesaler','synagogue supplies wholesaler'
    ];
    show('Searching Judaica…');
    for(const t of terms){
      const chunk = await textSearchOnce(`${t} in ${region}`);
      results = mergeUnique(results, chunk);
      show(`Loaded ${results.length} so far…`);
    }
  } else {
    const q = `${category} in ${region}`;
    show('Loading…');
    results = await textSearchOnce(q);
  }

  lastRaw = results;
  show(`Found ${results.length}. Fetching websites…`);
  await fetchDetailsFor(results);
  render(results);
  show(`Ready. Found ${results.length}.`);
}

function mergeUnique(a,b){
  const seen = new Set(a.map(x=>x.place_id));
  const out = a.slice();
  for(const r of (b||[])){
    if(!seen.has(r.place_id)){ seen.add(r.place_id); out.push(r); }
  }
  return out;
}

async function enrichContacts(){
  if(!lastRaw.length){ show('Run a search first.'); return; }
  const withSites = lastRaw.filter(x => (detailsCache.get(x.place_id)||{}).website).slice(0,80);
  if(!withSites.length){ show('No websites found to enrich.'); return; }
  show(`Enriching ${withSites.length} sites…`);
  let done=0;
  for(const r of withSites){
    const det = detailsCache.get(r.place_id) || {};
    try{
      const resp = await fetch(ENRICH_API_BASE + '?url=' + encodeURIComponent(det.website));
      const data = await resp.json();
      det._enrich = data;
      detailsCache.set(r.place_id, det);
    }catch(e){}
    done++;
    if(done%3===0) await new Promise(res=>setTimeout(res,150));
    setProgress((done/withSites.length)*100);
  }
  setProgress(100);
  render(lastRaw);
  show('Enrich done.');
}

init();
</script>
</body>
</html>
