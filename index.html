<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AKILOV Leads – Search + Enrich + CRM-lite</title>
<style>
:root{--bg:#0b1220;--card:#0f172a;--muted:#94a3b8;--border:#1f2937;--accent:#0ea5a6;--ok:#0f3d2e;--ok-border:#1a5e47}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1200px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
h2{margin:0 0 8px 0}
.small{font-size:12px;color:var(--muted)}
.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:#e5e7eb}
.select{appearance:none}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;cursor:pointer;font-size:13px}
.btn.primary{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.grid{display:grid;gap:8px}
.grid-3{grid-template-columns:2fr 2fr 160px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.badge{padding:4px 8px;border-radius:999px;background:#12233b;color:#93c5fd;font-size:12px;border:1px solid #1f3455}
.pill{border:1px solid #1f2937;border-radius:999px;padding:4px 10px}
.range{accent-color:#0ea5a6}
.nowrap{white-space:nowrap}
a.link{color:#93c5fd;text-decoration:none}
.progress{height:6px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
.progress > div{height:100%;background:#0ea5a6;width:0%}
tr.working{background:var(--ok)}
tr.working td{border-bottom-color:var(--ok-border)}
.legend{display:flex;align-items:center;gap:6px}
.legend .chip{width:12px;height:12px;background:var(--ok);border:1px solid var(--ok-border);border-radius:3px;display:inline-block}
</style>
</head>
<body>
<div class="container">
  <!-- SEARCH -->
  <div class="card">
    <h2>Live Search – Retailers / Wholesalers</h2>
    <div class="grid grid-3" style="margin-top:8px">
      <select class="input select" id="category">
        <optgroup label="Judaica">
          <option value="__JUDAICA_ALL__">Judaica (All)</option>
        </optgroup>
        <optgroup label="Home & Furniture">
          <option>home decor store</option><option>furniture store</option><option>lighting store</option>
          <option>art gallery</option><option>wallpaper store</option>
        </optgroup>
        <optgroup label="Kitchen & Tabletop">
          <option>housewares store</option><option>kitchen supply store</option>
          <option>tableware store</option><option>cookware store</option><option>kitchen accessories</option>
        </optgroup>
        <optgroup label="Gifts & Lifestyle">
          <option>gift shop</option><option>lifestyle store</option><option>concept store</option><option>department store home</option>
        </optgroup>
        <optgroup label="Wholesalers & Distributors">
          <option>home decor wholesaler</option><option>gift wholesaler</option>
          <option>furniture distributor</option><option>general merchandise wholesaler</option><option>buying office</option>
        </optgroup>
        <optgroup label="Designers & Trade">
          <option>interior design studio</option><option>interior designer</option><option>home staging company</option>
          <option>architecture firm</option><option>showroom</option>
        </optgroup>
      </select>

      <select class="input select" id="region">
        <optgroup label="USA">
          <option>New York, USA</option><option>Los Angeles, USA</option><option>Miami, USA</option>
          <option>Chicago, USA</option><option>Dallas, USA</option><option>San Francisco, USA</option>
          <option>Houston, USA</option><option>Seattle, USA</option><option>Atlanta, USA</option><option>Boston, USA</option>
        </optgroup>
        <optgroup label="Europe">
          <option>London, UK</option><option>Paris, France</option><option>Berlin, Germany</option>
          <option>Milan, Italy</option><option>Amsterdam, Netherlands</option><option>Stockholm, Sweden</option>
          <option>Madrid, Spain</option><option>Barcelona, Spain</option><option>Zurich, Switzerland</option>
        </optgroup>
        <optgroup label="Middle East">
          <option>Tel Aviv, Israel</option><option>Dubai, UAE</option>
        </optgroup>
      </select>

      <button class="btn primary" id="run">Live Search</button>
    </div>

    <div class="row" style="margin-top:10px">
      <label class="row small" style="gap:6px">
        <input type="checkbox" id="hideBrands" checked> Hide brand/D2C
      </label>
      <span class="pill small">Min Rating: <span id="ratingVal">4.0</span> ★</span>
      <input type="range" id="minRating" class="range" min="3.0" max="5.0" step="0.1" value="4.0" style="width:220px">
      <button class="btn" id="enrichBtn">Enrich contacts</button>
      <button class="btn" id="exportCsv">Export CSV</button>
      <button class="btn" id="exportWorking">Export Working</button>
      <button class="btn" id="importWorking">Import Working</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
      <span class="small legend"><span class="chip"></span> Working with (saved)</span>
      <span class="small" id="counts"></span>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="card">
    <table class="table">
      <thead>
        <tr>
          <th>Working</th>
          <th>Name</th>
          <th>Location</th>
          <th>Rating ★</th>
          <th class="nowrap">Reviews</th>
          <th>Phone</th>
          <th>Website</th>
          <th>Open</th>
          <th>Emails</th>
          <th>Social</th>
          <th>Categories</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div id="status" class="small" style="margin-top:8px"></div>
    <div class="progress" id="prog" style="display:none;margin-top:8px"><div></div></div>
    <button class="btn" id="loadMore" disabled style="margin-top:8px">Load more</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const ENRICH_API_BASE = 'https://akilov-leads.vercel.app/api/enrich'; // החלף אם השם אחר

/* ---------- State ---------- */
let places, lastRaw=[], detailsCache=new Map();
let _pagination=null;
const KEEP_TYPES = new Set(['store','home_goods_store','furniture_store','department_store','shopping_mall','lighting_store','wholesaler','distributor']);
const BLOCK_TYPES = new Set(['manufacturer','corporate_office','headquarters','factory']);
const BRAND_KEYWORDS = ['official','brand','atelier','factory','manufacturer','headquarters','hq','®','™','global brand','the brand'];

// Working saved locally
const WORKING_KEY='akilov_working_with';
let workingWith = new Set();
try{ workingWith = new Set(JSON.parse(localStorage.getItem(WORKING_KEY)||'[]')); }catch{}

/* ---------- Utils ---------- */
function $(s){ return document.querySelector(s) }
function show(msg){ const el=$('#status'); console.log(msg); el.textContent = typeof msg==='string'? msg : JSON.stringify(msg) }
function setProgress(p){ const bar=$('#prog'); const fill=bar.querySelector('div'); bar.style.display='block'; fill.style.width=(Math.max(0,Math.min(100,p))+'%'); if(p>=100) setTimeout(()=> bar.style.display='none', 600); }
function saveWorking(){ localStorage.setItem(WORKING_KEY, JSON.stringify(Array.from(workingWith))) }
function toggleWorking(id){ if(!id) return; if(workingWith.has(id)) workingWith.delete(id); else workingWith.add(id); saveWorking(); render(lastRaw); }

function looksLikeBrand(name, types){
  const n=(name||'').toLowerCase();
  if((types||[]).some(t=> BLOCK_TYPES.has(t))) return true;
  return BRAND_KEYWORDS.some(k=> n.includes(k));
}
function looksLikeRetailOrWholesale(types){
  const t=types||[];
  return t.some(x=> KEEP_TYPES.has(x)) || t.includes('point_of_interest') || t.includes('establishment');
}

function loadScript(src){ return new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=resolve; s.onerror=()=>reject(new Error('Maps JS failed')); document.head.appendChild(s) }) }
const qs=new URLSearchParams(location.search); const apiKey=qs.get('key');

/* ---------- Init ---------- */
(async function init(){
  if(!apiKey){ show('Missing API key. Open with ?key=YOUR_GOOGLE_API_KEY'); return; }
  await loadScript(`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(apiKey)}&libraries=places`);
  places = new google.maps.places.PlacesService(document.createElement('div'));
  $('#run').onclick = runSearch;
  $('#enrichBtn').onclick = enrichContacts;
  $('#loadMore').onclick = ()=>{ if(_pagination?.hasNextPage){ show('Loading more…'); setTimeout(()=> _pagination.nextPage(), 1200); } };
  $('#minRating').oninput = ()=>{ $('#ratingVal').textContent = parseFloat($('#minRating').value).toFixed(1); render(lastRaw); };

  $('#exportCsv').onclick = exportCsv;
  $('#exportWorking').onclick = exportWorking;
  $('#importWorking').onclick = ()=> $('#importFile').click();
  $('#importFile').onchange = importWorkingFile;

  show('Ready. Choose category & region and click Live Search.');
})();

/* ---------- Search ---------- */
function textSearchOnce(query){
  return new Promise((resolve)=>{
    places.textSearch({ query }, (results, status, pagination)=>{
      if(status !== google.maps.places.PlacesServiceStatus.OK && status !== google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
        resolve({list:[], pagination:null}); return;
      }
      resolve({list: results||[], pagination});
    });
  });
}

async function fetchDetailsFor(list){
  const fields=['place_id','name','formatted_address','types','rating','user_ratings_total','opening_hours','international_phone_number','formatted_phone_number','website'];
  let i=0;
  for(const r of list){
    await new Promise((resolve)=>{
      places.getDetails({ placeId: r.place_id, fields }, (det, status)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && det){
          detailsCache.set(r.place_id, det);
        }
        resolve();
      });
    });
    i++;
    if(i%5===0) await new Promise(r=>setTimeout(r,200));
    setProgress((i/list.length)*100);
  }
  setProgress(100);
}

function mergeUnique(a,b){ const seen=new Set(a.map(x=>x.place_id)); const out=a.slice(); for(const r of (b||[])){ if(!seen.has(r.place_id)){ seen.add(r.place_id); out.push(r); } } return out; }

async function runSearch(){
  const category=$('#category').value;
  const region=$('#region').value;
  lastRaw=[]; _pagination=null; $('#loadMore').disabled=true; $('#tbody').innerHTML='';
  if(category==='__JUDAICA_ALL__'){
    show('Searching Judaica…');
    const terms=['judaica store','jewish gift shop','jewish bookstore','jewish art gallery','synagogue gift shop','judaica wholesaler','jewish gift wholesaler','jewish religious items distributor','jewish ceremonial wholesaler','synagogue supplies wholesaler'];
    for(const t of terms){
      const {list} = await textSearchOnce(`${t} in ${region}`);
      lastRaw = mergeUnique(lastRaw, list);
      render(lastRaw); show(`Loaded ${lastRaw.length} so far…`);
    }
    show(`Found ${lastRaw.length}. Fetching websites…`);
    await fetchDetailsFor(lastRaw);
    render(lastRaw); show(`Ready. Found ${lastRaw.length}.`);
  }else{
    const q=`${category} in ${region}`;
    show('Loading…');
    places.textSearch({ query:q }, async (results, status, pagination)=>{
      if(status !== google.maps.places.PlacesServiceStatus.OK && status !== google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
        show('Places error: '+status); return;
      }
      lastRaw = results||[];
      render(lastRaw);
      _pagination = (pagination && pagination.hasNextPage) ? pagination : null;
      $('#loadMore').disabled = !_pagination;
      if(!_pagination){ show(`Found ${lastRaw.length}. Fetching websites…`); await fetchDetailsFor(lastRaw); render(lastRaw); show(`Ready. Found ${lastRaw.length}.`); }
      else { show(`Loaded ${lastRaw.length}. Click "Load more" for more.`); }
    });
  }
}

/* ---------- Enrich ---------- */
async function enrichContacts(){
  if(!lastRaw.length){ show('Run a search first.'); return; }
  const withSites = lastRaw.filter(x => (detailsCache.get(x.place_id)||{}).website).slice(0,100);
  if(!withSites.length){ show('No websites found to enrich.'); return; }
  show(`Enriching ${withSites.length} sites…`);
  let done=0;
  for(const r of withSites){
    const det = detailsCache.get(r.place_id) || {};
    try{
      const resp = await fetch(ENRICH_API_BASE + '?url=' + encodeURIComponent(det.website));
      const data = await resp.json();
      det._enrich = data;
      detailsCache.set(r.place_id, det);
    }catch(e){}
    done++;
    if(done%3===0) await new Promise(res=>setTimeout(res,150));
    setProgress((done/withSites.length)*100);
  }
  setProgress(100);
  render(lastRaw);
  show('Enrich done.');
}

/* ---------- Render ---------- */
function render(raw){
  const hideBrands = $('#hideBrands').checked;
  const minRating = parseFloat($('#minRating').value) || 0;

  const filtered = (raw||[]).filter(it=>{
    const types=it.types||[];
    if(!looksLikeRetailOrWholesale(types)) return false;
    if(hideBrands && looksLikeBrand(it.name, types)) return false;
    const rating = typeof it.rating==='number' ? it.rating : 0;
    return rating >= minRating;
  });

  const tbody=$('#tbody'); tbody.innerHTML='';
  const items = filtered.slice(0,200).map(it=>{
    const det = detailsCache.get(it.place_id) || {};
    const phone = det.international_phone_number || det.formatted_phone_number || '';
    const websiteUrl = det.website || '';
    const website = websiteUrl ? `<a class="link" href="${websiteUrl}" target="_blank">Website</a>` : '—';
    const openNow = det.opening_hours?.open_now===true ? 'Open' : (det.opening_hours?.open_now===false ? 'Closed' : '—');
    const reviews = (typeof it.user_ratings_total==='number') ? it.user_ratings_total : (typeof det.user_ratings_total==='number' ? det.user_ratings_total : '—');
    const rating = (typeof it.rating==='number') ? it.rating.toFixed(1) : (typeof det.rating==='number' ? det.rating.toFixed(1) : '—');
    const enrich = det._enrich || {};
    const bestEmail = enrich.best_email || '';
    const socials = enrich.socials || {};
    const socialsHtml = [
      socials.linkedin ? `<a class="link" href="${socials.linkedin}" target="_blank">LinkedIn</a>` : '',
      socials.instagram ? `<a class="link" href="${socials.instagram}" target="_blank">Instagram</a>` : '',
      socials.facebook ? `<a class="link" href="${socials.facebook}" target="_blank">Facebook</a>` : ''
    ].filter(Boolean).join(' · ');

    return {
      id: it.place_id,
      name: it.name,
      address: it.formatted_address || det.formatted_address || '',
      rating, reviews, phone, website, openNow,
      email: bestEmail,
      socialsHtml,
      categories: (it.types||[]).slice(0,3).join(', ')
    };
  });

  for(const it of items){
    const tr=document.createElement('tr');
    if(workingWith.has(it.id)) tr.classList.add('working');
    tr.innerHTML = `
      <td><button class="btn" onclick="toggleWorking('${it.id}')">${workingWith.has(it.id)?'Unmark':'Toggle'}</button></td>
      <td>${it.name}</td>
      <td class="small">${it.address}</td>
      <td class="nowrap"><span class="badge">${it.rating} ★</span></td>
      <td>${it.reviews}</td>
      <td class="small">${it.phone || '—'}</td>
      <td>${it.website || '—'}</td>
      <td>${it.openNow || '—'}</td>
      <td class="small nowrap">${it.email || '—'}</td>
      <td class="small">${it.socialsHtml || '—'}</td>
      <td class="small">${it.categories}</td>
    `;
    tbody.appendChild(tr);
  }
  $('#counts').textContent = `Showing ${items.length} / ${raw?.length||0}`;
  if(!_pagination || !_pagination.hasNextPage){ $('#loadMore').disabled = true; }
}

/* ---------- Export / Import ---------- */
function exportCsv(){
  const rows = Array.from(document.querySelectorAll('#tbody tr')).map(tr=>{
    const tds = tr.querySelectorAll('td');
    return [
      (tr.classList.contains('working') ? 'yes' : 'no'),
      tds[1]?.innerText || '', // name
      tds[2]?.innerText || '', // address
      tds[3]?.innerText || '', // rating
      tds[4]?.innerText || '', // reviews
      tds[5]?.innerText || '', // phone
      tds[6]?.innerText || '', // website
      tds[7]?.innerText || '', // open
      tds[8]?.innerText || '', // email
      tds[9]?.innerText || '', // social
      tds[10]?.innerText || '' // categories
    ];
  });
  const header = ['Working','Name','Location','Rating','Reviews','Phone','Website','Open','Email','Social','Categories'];
  const csv = [header].concat(rows).map(r=> r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'akilov-leads.csv'; a.click();
  URL.revokeObjectURL(url);
}

function exportWorking(){
  const arr = Array.from(workingWith);
  const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'akilov-working.json'; a.click();
  URL.revokeObjectURL(url);
}

async function importWorkingFile(e){
  const f = e.target.files && e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Bad file format');
    for(const id of arr){ if(id && typeof id==='string') workingWith.add(id) }
    saveWorking(); render(lastRaw); show(`Imported ${arr.length} working items.`);
  }catch(err){ show('Import failed: '+(err.message||err)); }
  e.target.value='';
}
</script>
</body>
</html>
