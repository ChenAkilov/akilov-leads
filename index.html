<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>AKILOV - Leads Library ¬∑ Search ¬∑ CRM ¬∑ Working ¬∑ Maps</title>
<style>
:root{ --bg:#0c0f14; --card:#131822; --text:#e8eaee; --muted:#9da6b5; --border:#263043; --accent:#0ea5a6; --table-stripe:transparent; }
html[data-theme="light"]{ --bg:#ffffff; --card:#f6f7fb; --text:#0c0f14; --muted:#5c6575; --border:#e3e8f3; --table-stripe:#f0f3fa; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;transition:background-color .2s,color .2s}
.container{max-width:1240px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;transition:background-color .2s,border-color .2s}
h2{margin:0 0 8px 0} .small{font-size:12px;color:var(--muted)}
.input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text)}
.select{appearance:none}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;cursor:pointer;font-size:13px;transition:transform .05s,opacity .2s,background-color .2s,color .2s;text-decoration:none;display:inline-block}
html[data-theme="light"] .btn{background:#1f2937;color:#e5e7eb} .btn.primary{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.grid{display:grid;gap:8px} .grid-4{grid-template-columns:2fr 2fr 2fr 160px} .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse} .table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
.table tbody tr:nth-child(2n){background:var(--table-stripe)}
.badge{padding:4px 8px;border-radius:999px;background:#12233b;color:#93c5fd;font-size:12px;border:1px solid #1f3455}
html[data-theme="light"] .badge{background:#e6f0ff;color:#1b3a74;border-color:#cfe0ff}
.pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px}
.nowrap{white-space:nowrap} a.link{color:#93c5fd;text-decoration:none} html[data-theme="light"] a.link{color:#1f52ff}
.progress{height:6px;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden} .progress > div{height:100%;background:var(--accent);width:0%}
tr.working{background:#065f4633} tr.closed{opacity:.6}
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:#0d1730;color:#cfe6ff}
html[data-theme="light"] .tab{background:#eaf2ff;color:#14365d} .tab.active{background:var(--accent);color:#062a2d;border-color:transparent;font-weight:600}
.hidden{display:none} .badge-stage{padding:2px 8px;border-radius:999px;border:1px solid #2b3b4f;background:#152232;font-size:12px}
.btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:not-allowed}
.btn.loading{position:relative}
.btn.loading::after{content:'';position:absolute;right:10px;top:50%;width:12px;height:12px;margin-top:-6px;border-radius:50%;border:2px solid rgba(255,255,255,.5);border-top-color:transparent;animation:akilovSpin .8s linear infinite}
@keyframes akilovSpin{to{transform:rotate(360deg)}} .btn.success{background:#16a34a!important;color:#05240f!important} .btn.error{background:#b91c1c!important;color:#2a0b0b!important}
.theme-toggle{margin-left:auto;display:flex;align-items:center;gap:8px} .switch{position:relative;width:52px;height:28px;border-radius:999px;border:1px solid var(--border);background:transparent;cursor:pointer}
.switch .knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:var(--text);transition:left .18s}
html[data-theme="light"] .switch .knob{left:26px} .switch .icon{font-size:12px;position:absolute;top:6px;color:#9da6b5} .switch .sun{left:8px} .switch .moon{right:8px}
.map { width:100%; height:560px; border:1px solid var(--border); border-radius:16px; background:transparent }
.badge-closed{padding:2px 6px;border-radius:8px;background:#3a2430;border:1px solid #6b2b43;color:#f6b0c3;font-size:11px}
</style>
</head>
<body>
<div class="container">
  <div class="row" style="margin-bottom:8px">
    <div class="tabs" style="margin:0">
      <div class="tab active" id="tabSearch">Search</div>
      <div class="tab" id="tabCrm">CRM</div>
      <div class="tab" id="tabWorking">Working</div>
      <div class="tab" id="tabMaps">Maps</div>
    </div>
    <div class="theme-toggle" title="Light / Dark">
      <span class="small">Theme</span>
      <div id="themeSwitch" class="switch" role="button" aria-label="Toggle theme">
        <span class="icon sun">‚òÄÔ∏è</span><span class="icon moon">üåô</span><div class="knob"></div>
      </div>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="panelSearch">
    <div class="card">
      <h2>Live Search and Library</h2>
      <div class="grid grid-4" style="margin-top:8px">
        <select class="input select" id="category">
          <optgroup label="Judaica"><option value="__JUDAICA_ALL__">Judaica (All)</option></optgroup>
          <optgroup label="Home and Furniture">
            <option>home decor store</option><option>furniture store</option><option>lighting store</option>
            <option>art gallery</option><option>wallpaper store</option>
          </optgroup>
          <optgroup label="Kitchen and Tabletop">
            <option>housewares store</option><option>kitchen supply store</option>
            <option>tableware store</option><option>cookware store</option><option>kitchen accessories</option>
          </optgroup>
          <optgroup label="Gifts and Lifestyle">
            <option>gift shop</option><option>lifestyle store</option><option>concept store</option><option>department store home</option>
          </optgroup>
          <optgroup label="Wholesalers and Distributors">
            <option>home decor wholesaler</option><option>gift wholesaler</option>
            <option>furniture distributor</option><option>general merchandise wholesaler</option><option>buying office</option>
          </optgroup>
          <optgroup label="Designers and Trade">
            <option>interior design studio</option><option>interior designer</option><option>home staging company</option>
            <option>architecture firm</option><option>showroom</option>
          </optgroup>
        </select>

        <select class="input select" id="country">
          <optgroup label="Core"><option>Israel</option><option>USA</option></optgroup>
          <optgroup label="Europe"><option>United Kingdom</option><option>France</option><option>Germany</option><option>Italy</option><option>Netherlands</option><option>Sweden</option><option>Spain</option><option>Switzerland</option></optgroup>
          <optgroup label="Middle East"><option>United Arab Emirates</option></optgroup>
        </select>

        <select class="input select" id="scope" disabled>
          <option value="__ALL__">All country</option>
        </select>

        <button class="btn primary" id="run">Search and Sync</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideBrands" checked> Hide brand or D2C</label>
        <label class="row small" style="gap:6px"><input type="checkbox" id="hideCrmLeads"> Hide leads already in CRM</label>
        <label class="row small" style="gap:6px"><input type="checkbox" id="showClosed"> Include closed</label>
        <button class="btn" id="enrichBtn">Enrich contacts</button>
        <button class="btn" id="exportCsv">Export CSV</button>
        <label class="row small" style="gap:6px;margin-left:auto"><input type="checkbox" id="autoSync"> Auto search on load</label>
      </div>
      <div class="small" style="margin-top:6px">Optional: ?api=https://your-vercel.app/api and ?key=YOUR_GOOGLE_API_KEY (map only)</div>
    </div>

    <div class="card">
      <table class="table">
        <thead><tr>
          <th>Actions</th><th>Name</th><th>Location</th><th>Rating ‚òÖ</th><th class="nowrap">Reviews</th>
          <th>Phone</th><th>Website</th><th>Status</th><th>Emails</th><th>Social</th><th>Categories</th><th>CRM</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="status" class="small" style="margin-top:8px"></div>
      <div class="progress" id="prog" style="display:none;margin-top:8px"><div></div></div>
    </div>
  </div>

  <!-- CRM -->
  <div id="panelCrm" class="hidden">
    <div class="card">
      <h2>CRM</h2>
      <div class="row small">
        <span>Stages:</span>
        <span class="badge-stage">New</span>
        <span class="badge-stage">Contacted</span>
        <span class="badge-stage">Qualified</span>
        <span class="badge-stage">Negotiation</span>
        <span class="badge-stage">Won</span>
        <span class="badge-stage">Lost</span>
      </div>
    </div>
    <div class="card">
      <table class="table">
        <thead><tr>
          <th>Actions</th><th>Name</th><th>Stage</th><th>Email</th><th>Phone</th><th>Website</th><th>Notes</th><th>Updated</th>
        </tr></thead>
        <tbody id="tbodyCrm"></tbody>
      </table>
      <div id="statusCrm" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- WORKING -->
  <div id="panelWorking" class="hidden">
    <div class="card">
      <h2>Working (All)</h2>
      <div class="row">
        <input class="input" id="workingSearch" placeholder="Search by name or city" style="max-width:340px">
      </div>
    </div>
    <div class="card">
      <table class="table">
        <thead><tr><th>Actions</th><th>Name</th><th>Location</th><th>Country</th><th>Google</th></tr></thead>
        <tbody id="tbodyWorking"></tbody>
      </table>
      <div id="statusWorking" class="small" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- MAPS -->
  <div id="panelMaps" class="hidden">
    <div class="card">
      <h2>Maps - Working (green pins)</h2>
      <div id="map" class="map"></div>
      <div id="statusMap" class="small" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const qs = new URLSearchParams(location.search);
const API_BASE = (qs.get('api') || 'https://akilov-leads.vercel.app/api').replace(/\/$/, '');
const GOOGLE_KEY = qs.get('key') || '';
const JUDAICA_PACK = [
  'judaica store','jewish gift shop','jewish bookstore','jewish art gallery','synagogue gift shop'
];
const BRAND_WORDS = ['official','brand','factory','outlet','warehouse','headquarters','corp','corporate'];
let PLACES_SERVICE=null;

/* ====== THEME ====== */
const theme = localStorage.getItem('ak_theme') || 'dark';
document.documentElement.setAttribute('data-theme', theme);
document.getElementById('themeSwitch').onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme', cur);
  localStorage.setItem('ak_theme', cur);
};

/* ====== TABS ====== */
const panels={ Search:'panelSearch', Crm:'panelCrm', Working:'panelWorking', Maps:'panelMaps' };
function activateTab(id){
  for(const el of document.querySelectorAll('.tab')) el.classList.remove('active');
  for(const p of Object.values(panels)) document.getElementById(p).classList.add('hidden');
  document.getElementById('tab'+id).classList.add('active');
  document.getElementById(panels[id]).classList.remove('hidden');
  if(id==='Maps') renderMap();
  if(id==='Crm') loadCrm();
  if(id==='Working') renderWorking();
}
document.getElementById('tabSearch').onclick=()=>activateTab('Search');
document.getElementById('tabCrm').onclick=()=>activateTab('Crm');
document.getElementById('tabWorking').onclick=()=>activateTab('Working');
document.getElementById('tabMaps').onclick=()=>activateTab('Maps');

/* ====== SCOPE OPTIONS (USA states or Israel cities) ====== */
const USA_STATES=['New York','California','Florida','Texas','Illinois','New Jersey','Massachusetts','Pennsylvania','Georgia','Washington','Ohio','Virginia','Arizona','Colorado'];
const IL_CITIES=['Tel Aviv','Jerusalem','Haifa','Rishon LeZion','Petah Tikva','Ashdod','Netanya','Beersheba','Holon','Bnei Brak','Ramat Gan','Rehovot','Bat Yam','Ashkelon','Herzliya','Kfar Saba','Ra\'anana','Givatayim','Hod HaSharon','Modiin','Beit Shemesh'];
const countrySel=document.getElementById('country'), scopeSel=document.getElementById('scope');
function refreshScope(){
  const c=countrySel.value;
  scopeSel.innerHTML='';
  let opts=[];
  if(c==='USA'){ opts=USA_STATES.map(s=>({v:s,label:s+' (state)'})); }
  else if(c==='Israel'){ opts=IL_CITIES.map(s=>({v:s,label:s})); }
  else { scopeSel.disabled=true; scopeSel.innerHTML='<option value="__ALL__">All country</option>'; return; }
  scopeSel.disabled=false; scopeSel.appendChild(new Option('All country','__ALL__'));
  for(const o of opts) scopeSel.appendChild(new Option(o.label,o.v));
}
countrySel.onchange=refreshScope; refreshScope();

/* ====== STATE ====== */
let CRM_STATE={ leads:[], working:[] };
let CURRENT_ROWS=[];

/* ====== HELPERS ====== */
const statusEl=document.getElementById('status'), prog=document.getElementById('prog'), progBar=prog.firstElementChild;
function setStatus(t){ statusEl.textContent=t||''; }
function setBtnLoading(btn, on){ btn.classList.toggle('loading',!!on); btn.disabled=!!on; }
function scoreIsBrand(name){ const s=(name||'').toLowerCase(); return BRAND_WORDS.some(w=>s.includes(w)); }
function gmapsLink(name,address){ return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((name||'')+' '+(address||''))}`; }
function websiteLink(u){ try{ const url=new URL(u); return `<a class="link" href="${url.toString()}" target="_blank" rel="noopener">${url.hostname.replace('www.','')}</a>`; }catch{return ''; } }
function regionCode(country){ if(country==='USA') return 'US'; if(country==='Israel') return 'IL'; return 'EU'; }

/* ====== API (serverless v1 expects POST JSON) ====== */
async function apiPost(path, body){
  const r = await fetch(API_BASE + path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
  if(!r.ok){ const t=await r.text(); throw new Error('HTTP '+r.status+': '+t); }
  return r.json();
}

async function loadCrm(){
  try{
    const list = await apiPost('/crm', { action:'list' });
    const working = await apiPost('/crm', { action:'listWorking' });
    CRM_STATE.leads = list.items || [];
    CRM_STATE.working = working.items || [];
    renderCrm(); renderWorking();
  }catch(e){ console.warn('CRM load failed', e); }
}

/* ====== RENDER SEARCH TABLE ====== */
const tbody=document.getElementById('tbody');
function renderRows(rows){
  tbody.innerHTML='';
  const hideBrands=document.getElementById('hideBrands').checked;
  const hideCrm=document.getElementById('hideCrmLeads').checked;
  const showClosed=document.getElementById('showClosed').checked;
  const crmIds=new Set((CRM_STATE.leads||[]).map(x=>x.place_id));
  for(const it of rows){
    if(hideBrands && scoreIsBrand(it.name)) continue;
    if(hideCrm && crmIds.has(it.place_id)) continue;
    if(!showClosed && (it.business_status||'').toUpperCase().includes('CLOSED')) continue;

    const tr=document.createElement('tr');
    if((CRM_STATE.working||[]).some(w=>w.place_id===it.place_id && w.working)) tr.classList.add('working');
    if((it.business_status||'').toUpperCase().includes('CLOSED')) tr.classList.add('closed');

    const aGoogle = `<a class="btn" href="${gmapsLink(it.name,it.address)}" target="_blank">Google</a>`;
    const aWebsite = websiteLink(it.website);
    const rating = (typeof it.rating==='number' ? it.rating.toFixed(1) : '');
    const reviews = (typeof it.user_ratings_total==='number' ? it.user_ratings_total : (typeof it.reviews==='number'?it.reviews:''));

    const emailsArr = Array.isArray(it.enrich_emails) ? it.enrich_emails : (it.enrich_emails?.emails_ranked || []);
    const emails = (emailsArr.length?emailsArr:[it.email]).filter(Boolean).slice(0,2).join(', ');
    const socialsArr = Array.isArray(it.enrich_socials) ? it.enrich_socials : (it.enrich_socials?Object.values(it.enrich_socials):[]);
    const socials = socialsArr.slice(0,1).map(u=>`<a class="link" href="${u}" target="_blank">link</a>`).join('');

    const workingBtn = `<button class="btn btn-working" data-id="${it.place_id}">Working</button>`;
    const crmBtn = `<button class="btn btn-addcrm" data-id="${it.place_id}">Add to CRM</button>`;
    const enrichBtn = `<button class="btn btn-enrich" data-id="${it.place_id}">Enrich</button>`;

    tr.innerHTML = `
      <td class="nowrap">${aGoogle} ${enrichBtn} ${workingBtn} ${crmBtn}</td>
      <td>${it.name||''}</td>
      <td class="small">${(it.address||'').split(',').slice(0,2).join(', ')}</td>
      <td>${rating?`<span class="badge">${rating}</span>`:''}</td>
      <td>${reviews||''}</td>
      <td class="small">${it.phone||''}</td>
      <td>${aWebsite||''}</td>
      <td>${it.business_status?`<span class="badge-closed">${it.business_status}</span>`:''}</td>
      <td class="small">${emails||''}</td>
      <td>${socials||''}</td>
      <td class="small">${it.categories||''}</td>
      <td class="small">${crmIds.has(it.place_id)?'<span class="badge">in CRM</span>':''}</td>
    `;
    tr.dataset.row = JSON.stringify(it);
    tbody.appendChild(tr);
  }
  document.getElementById('status').textContent = `${tbody.children.length} rows`;
  bindRowButtons();
}
function findRow(id){ for(const r of CURRENT_ROWS) if(r.place_id===id) return r; return null; }
function bindRowButtons(){
  for(const b of document.querySelectorAll('.btn-enrich')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row) return; setBtnLoading(e.currentTarget,true);
    try{
      const j=await apiPost('/enrich',{ items:[row] });
      const out=j.items && j.items[0] ? j.items[0] : row;
      CURRENT_ROWS = CURRENT_ROWS.map(x=>x.place_id===id?{...x,...out}:x);
      renderRows(CURRENT_ROWS);
    }catch(err){ alert('Enrich failed'); }
  };
  for(const b of document.querySelectorAll('.btn-working')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row) return; setBtnLoading(e.currentTarget,true);
    try{
      const isOn = !(CRM_STATE.working||[]).some(w=>w.place_id===id && w.working);
      await apiPost('/crm',{ action:'setWorking', place_id:id, working:isOn });
      await loadCrm(); renderRows(CURRENT_ROWS);
    }catch(err){ alert('Working toggle failed'); }
  };
  for(const b of document.querySelectorAll('.btn-addcrm')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; const row=findRow(id); if(!row) return; setBtnLoading(e.currentTarget,true);
    try{
      const payload = {
        place_id: row.place_id, name: row.name, address: row.address, website: row.website, phone: row.phone,
        rating: row.rating, user_ratings_total: row.user_ratings_total || row.reviews,
        email: row.email || null, enrich_emails: row.enrich_emails || null, enrich_socials: row.enrich_socials || null,
        lat: row.lat, lng: row.lng, city: row.city, state: row.state, country: row.country
      };
      await apiPost('/crm',{ action:'upsert', item:payload });
      await loadCrm(); renderRows(CURRENT_ROWS);
    }catch(err){ alert('Add to CRM failed'); }
  };
}

/* ====== EXPORT CSV ====== */
document.getElementById('exportCsv').onclick=()=>{
  const rows=[...tbody.querySelectorAll('tr')].map(tr=>JSON.parse(tr.dataset.row||'{}'));
  const cols=['place_id','name','address','country','phone','website','rating','user_ratings_total','categories','business_status','email'];
  const csv=[cols.join(',')].concat(rows.map(r=>cols.map(k=>JSON.stringify(r[k]??'')).join(','))).join('\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='akilov_export.csv'; a.click();
};

/* ====== ENRICH BATCH ====== */
document.getElementById('enrichBtn').onclick=async()=>{
  const btn=document.getElementById('enrichBtn'); setBtnLoading(btn,true);
  try{
    const rows=[...tbody.querySelectorAll('tr')].map(tr=>JSON.parse(tr.dataset.row||'{}'));
    const batchSize=10; let done=0; const total=rows.length; prog.style.display='block';
    for(let i=0;i<rows.length;i+=batchSize){
      const slice=rows.slice(i,i+batchSize);
      try{
        const j=await apiPost('/enrich',{ items:slice });
        const out=j.items||[];
        const byId=new Map(out.map(x=>[x.place_id,x]));
        CURRENT_ROWS=CURRENT_ROWS.map(x=>byId.get(x.place_id)?{...x,...byId.get(x.place_id)}:x);
      }catch(_){ /* ignore */ }
      done+=slice.length; progBar.style.width=((done/total)*100)+'%';
    }
    renderRows(CURRENT_ROWS);
  }finally{ setBtnLoading(btn,false); setTimeout(()=>{prog.style.display='none'; progBar.style.width='0%';},400); }
};

/* ====== SEARCH and SYNC (serverless v1) ====== */
document.getElementById('run').onclick=runSync;
document.getElementById('hideBrands').onchange=()=>renderRows(CURRENT_ROWS);
document.getElementById('hideCrmLeads').onchange=()=>renderRows(CURRENT_ROWS);
document.getElementById('showClosed').onchange=()=>renderRows(CURRENT_ROWS);

async function runSync(){
  const btn=document.getElementById('run'); setBtnLoading(btn,true); setStatus('Loading CRM...');
  await loadCrm();
  const category=document.getElementById('category').value;
  const country=countrySel.value;
  const scope=scopeSel.disabled?'__ALL__':scopeSel.value;
  const cats = (category==='__JUDAICA_ALL__') ? JUDAICA_PACK : [category];

  setStatus('Searching live...');
  let all=[];
  for(const cat of cats){
    const qBase = (scope==='__ALL__') ? `${cat} in ${country}` : `${cat} in ${scope}, ${country}`;
    try{
      const res = await apiPost('/search', { q: qBase, region: regionCode(country), limit: 40, refresh: true, enrich: false });
      const items = res.items || [];
      all = all.concat(items);
    }catch(e){ console.warn('search error', e); }
  }
  // dedupe by place_id
  const seen=new Set();
  CURRENT_ROWS = all.filter(x=>x.place_id && !seen.has(x.place_id) && seen.add(x.place_id));
  renderRows(CURRENT_ROWS);
  setStatus(`Found ${CURRENT_ROWS.length} results and saved to library`);
  setBtnLoading(btn,false);
}

/* ====== CRM RENDER and ACTIONS ====== */
const tbodyCrm=document.getElementById('tbodyCrm');
function renderCrm(){
  tbodyCrm.innerHTML='';
  for(const lead of (CRM_STATE.leads||[])){
    const tr=document.createElement('tr');
    const stageSel = `
      <select class="input select sel-stage" data-id="${lead.place_id}">
        ${['New','Contacted','Qualified','Negotiation','Won','Lost'].map(s=>`<option ${lead.stage===s?'selected':''}>${s}</option>`).join('')}
      </select>`;
    tr.innerHTML=`
      <td class="nowrap">
        <a class="btn" href="${gmapsLink(lead.name, lead.address)}" target="_blank">Open</a>
        <button class="btn btn-del" data-id="${lead.place_id}">Delete</button>
      </td>
      <td>${lead.name||''}</td>
      <td>${stageSel}</td>
      <td class="small">${lead.email||''}</td>
      <td class="small">${lead.phone||''}</td>
      <td>${websiteLink(lead.website)||''}</td>
      <td>
        <div class="row" style="gap:6px">
          <input class="input inp-note" data-id="${lead.place_id}" placeholder="Add note" style="width:240px">
          <button class="btn btn-note" data-id="${lead.place_id}">Save</button>
        </div>
        <div class="small" style="white-space:pre-wrap;margin-top:6px">${lead.notes||''}</div>
      </td>
      <td class="small">${(lead.updated_at||'').toString().replace('T',' ').slice(0,19)}</td>
    `;
    tbodyCrm.appendChild(tr);
  }
  document.getElementById('statusCrm').textContent = `${(CRM_STATE.leads||[]).length} leads`;
  // bind:
  for(const s of tbodyCrm.querySelectorAll('.sel-stage')) s.onchange = async (e)=>{
    const id=e.target.dataset.id, stage=e.target.value;
    await apiPost('/crm',{ action:'setStage', place_id:id, stage});
    await loadCrm();
  };
  for(const b of tbodyCrm.querySelectorAll('.btn-note')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id;
    const input=tbodyCrm.querySelector(`.inp-note[data-id="${id}"]`); const note=input.value.trim(); if(!note) return;
    await apiPost('/crm',{ action:'addNote', place_id:id, note});
    input.value=''; await loadCrm();
  };
  for(const b of tbodyCrm.querySelectorAll('.btn-del')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id; if(!confirm('Delete lead?')) return;
    await apiPost('/crm',{ action:'delete', place_id:id });
    await loadCrm();
  };
}

/* ====== WORKING TAB ====== */
const tbodyWorking=document.getElementById('tbodyWorking');
function renderWorking(){
  const q=(document.getElementById('workingSearch').value||'').toLowerCase();
  tbodyWorking.innerHTML='';
  for(const w of (CRM_STATE.working||[])){
    if(!w.working) continue;
    if(q && !(`${w.name} ${w.address} ${w.country}`.toLowerCase().includes(q))) continue;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="nowrap">
        <button class="btn btn-wk-off" data-id="${w.place_id}">Remove</button>
      </td>
      <td>${w.name||''}</td>
      <td class="small">${w.address||''}</td>
      <td>${w.country||''}</td>
      <td><a class="btn" href="${gmapsLink(w.name,w.address)}" target="_blank">Google</a></td>
    `;
    tbodyWorking.appendChild(tr);
  }
  document.getElementById('statusWorking').textContent = `${tbodyWorking.children.length} working`;
  for(const b of tbodyWorking.querySelectorAll('.btn-wk-off')) b.onclick = async (e)=>{
    const id=e.currentTarget.dataset.id;
    await apiPost('/crm',{ action:'setWorking', place_id:id, working:false });
    await loadCrm(); renderRows(CURRENT_ROWS);
  };
}
document.getElementById('workingSearch').oninput=()=>renderWorking();

/* ====== MAPS (WORKING) ====== */
let MAP=null, MARKERS=[];
async function loadGoogle(){
  if(!GOOGLE_KEY) throw new Error('Missing Google API Key (?key=...)');
  if(window.google?.maps?.places){ return; }
  await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places`; s.async=true; s.onload=res; s.onerror=()=>rej(new Error('Failed to load Google Maps JS')); document.head.appendChild(s); });
}
async function renderMap(){
  try{
    if(!GOOGLE_KEY){ document.getElementById('statusMap').textContent='Open with ?key=YOUR_GOOGLE_API_KEY to view the map.'; return; }
    await loadGoogle();
    const el=document.getElementById('map');
    if(!MAP){ MAP=new google.maps.Map(el,{center:{lat:31.4,lng:34.9},zoom:2,mapTypeControl:false,streetViewControl:false}); }
    for(const m of MARKERS){ m.setMap(null); } MARKERS.length=0;
    const items=(CRM_STATE.working||[]).filter(x=>x.working && typeof x.lat==='number' && typeof x.lng==='number');
    for(const it of items){ const m=new google.maps.Marker({ position:{lat:it.lat,lng:it.lng}, map:MAP, title:it.name }); const inf=new google.maps.InfoWindow({ content:`<div><b>${it.name||''}</b><div class="small">${it.address||''}</div><a href="${gmapsLink(it.name,it.address)}" target="_blank">Open in Maps</a></div>` }); m.addListener('click',()=>inf.open({anchor:m,map:MAP})); MARKERS.push(m); }
    if(items[0]) MAP.setCenter({lat:items[0].lat,lng:items[0].lng});
    document.getElementById('statusMap').textContent=`${items.length} pins`;
  }catch(e){ document.getElementById('statusMap').textContent='Map error: '+e.message; }
}

/* ====== AUTO SYNC ON LOAD ====== */
try{ document.getElementById('autoSync').checked = localStorage.getItem('ak_auto')==='1'; }catch{}
document.getElementById('autoSync').onchange=()=>localStorage.setItem('ak_auto', document.getElementById('autoSync').checked?'1':'0');
window.addEventListener('load', async ()=>{
  try{ await loadCrm(); }catch(_){ }
  if(document.getElementById('autoSync').checked){ runSync(); }
});
</script>
</body>
</html>
